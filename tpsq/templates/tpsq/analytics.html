<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civic Engagement Analytics | TPSQ Dashboard</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <style>
        :root {
            --cisd-primary: #2B5CE6;
            --cisd-secondary: #0EA5E9;
            --cisd-success: #10B981;
            --cisd-warning: #F97316;
            --cisd-danger: #EF4444;
            --cisd-dark: #1E40AF;
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--cisd-primary) !important;
        }

        .metric-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .metric-change {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .metric-change.positive { color: var(--cisd-success); }
        .metric-change.negative { color: var(--cisd-danger); }
        .metric-change.neutral { color: #6c757d; }

        .funnel-step {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .funnel-step:hover {
            border-color: var(--cisd-primary);
            background: linear-gradient(135deg, #e7f1ff, #dbeafe);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .preference-bar {
            height: 20px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .preference-segment {
            height: 100%;
            display: inline-block;
            transition: width 0.5s ease;
        }

        .preference-segment.yes-would-use { background-color: #10B981; }
        .preference-segment.not-sure { background-color: #F59E0B; }
        .preference-segment.no-wouldnt-use { background-color: #EF4444; }

        .preference-segment.nothing { background-color: #94a3b8; }
        .preference-segment.notification { background-color: var(--cisd-secondary); }
        .preference-segment.updates { background-color: var(--cisd-primary); }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid var(--cisd-primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .table-hover tbody tr:hover {
            background-color: rgba(43, 92, 230, 0.05);
        }

        .badge-source {
            background-color: var(--cisd-primary);
            color: white;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .status-indicator.online { background-color: var(--cisd-success); }
        .status-indicator.loading { background-color: var(--cisd-warning); }
        .status-indicator.error { background-color: var(--cisd-danger); }
    </style>
</head>

<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-graph-up me-2"></i>
                TPSQ Analytics
            </a>
            <div class="navbar-nav ms-auto">
                <span class="nav-text text-muted">
                    <span class="status-indicator" :class="{'online': !loading, 'loading': loading}"></span>
                    <span x-text="loading ? 'Loading...' : 'Live Data'"></span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Dashboard -->
    <div class="container-fluid py-4" x-data="dashboardApp()">

        <!-- Header with Date Range -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-1">Civic Engagement Dashboard</h2>
                        <p class="text-muted mb-0">
                            <span x-text="formatDateRange()"></span>
                            <span class="ms-2 text-success" x-show="!loading">
                                <i class="bi bi-check-circle me-1"></i>Live
                            </span>
                        </p>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary btn-sm"
                                @click="changeDateRange(7)"
                                :class="{'active': dateRange === 7}">
                            7 Days
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm"
                                @click="changeDateRange(30)"
                                :class="{'active': dateRange === 30}">
                            30 Days
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm"
                                @click="changeDateRange(90)"
                                :class="{'active': dateRange === 90}">
                            90 Days
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" @click="refreshData()">
                            <i class="bi bi-arrow-clockwise" :class="{'fa-spin': loading}"></i>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Key Metrics Row -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <div class="metric-value text-primary" x-text="formatNumber(stats.overview?.total_sessions || 0)">
                            <div class="loading-spinner" x-show="loading"></div>
                        </div>
                        <div class="metric-label">Total Sessions</div>
                        <div class="metric-change positive">
                            <i class="bi bi-arrow-up"></i>
                            <span x-text="stats.overview?.sessions_24h || 0"></span> today
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <div class="metric-value text-success" x-text="formatNumber(stats.overview?.total_signups || 0)">
                            <div class="loading-spinner" x-show="loading"></div>
                        </div>
                        <div class="metric-label">Total Signups</div>
                        <div class="metric-change positive">
                            <i class="bi bi-arrow-up"></i>
                            <span x-text="stats.overview?.signups_24h || 0"></span> today
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <div class="metric-value text-warning" x-text="(stats.overview?.conversion_rate || 0).toFixed(1) + '%'">
                            <div class="loading-spinner" x-show="loading"></div>
                        </div>
                        <div class="metric-label">Conversion Rate</div>
                        <div class="metric-change neutral">
                            <i class="bi bi-graph-up"></i>
                            Page to signup
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <div class="metric-value text-info" x-text="(stats.overview?.bounce_rate || 0).toFixed(1) + '%'">
                            <div class="loading-spinner" x-show="loading"></div>
                        </div>
                        <div class="metric-label">Bounce Rate</div>
                        <div class="metric-change neutral">
                            <i class="bi bi-clock"></i>
                            <span x-text="(stats.overview?.avg_time_on_site || 0).toFixed(1)"></span>min avg
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conversion Funnel -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-funnel me-2"></i>
                            Conversion Funnel
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-2 mb-3">
                                <div class="funnel-step p-3 rounded">
                                    <div class="h4 mb-1 text-primary" x-text="formatNumber(stats.funnel?.page_views || 0)"></div>
                                    <div class="small text-muted">Page Views</div>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <div class="funnel-step p-3 rounded">
                                    <div class="h4 mb-1 text-info" x-text="formatNumber(stats.funnel?.surveys_started || 0)"></div>
                                    <div class="small text-muted">Survey Started</div>
                                    <div class="tiny text-success" x-text="calculateDropoff(stats.funnel?.surveys_started, stats.funnel?.page_views)"></div>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <div class="funnel-step p-3 rounded">
                                    <div class="h4 mb-1 text-warning" x-text="formatNumber(stats.funnel?.surveys_completed || 0)"></div>
                                    <div class="small text-muted">Survey Complete</div>
                                    <div class="tiny text-success" x-text="calculateDropoff(stats.funnel?.surveys_completed, stats.funnel?.surveys_started)"></div>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <div class="funnel-step p-3 rounded">
                                    <div class="h4 mb-1 text-secondary" x-text="formatNumber(stats.funnel?.forms_started || 0)"></div>
                                    <div class="small text-muted">Form Started</div>
                                    <div class="tiny text-success" x-text="calculateDropoff(stats.funnel?.forms_started, stats.funnel?.surveys_completed)"></div>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <div class="funnel-step p-3 rounded">
                                    <div class="h4 mb-1 text-danger" x-text="formatNumber(stats.funnel?.signup_attempts || 0)"></div>
                                    <div class="small text-muted">Signup Attempts</div>
                                    <div class="tiny text-success" x-text="calculateDropoff(stats.funnel?.signup_attempts, stats.funnel?.forms_started)"></div>
                                </div>
                            </div>
                            <div class="col-md-2 mb-3">
                                <div class="funnel-step p-3 rounded bg-success text-white">
                                    <div class="h4 mb-1" x-text="formatNumber(stats.funnel?.successful_signups || 0)"></div>
                                    <div class="small">Successful</div>
                                    <div class="tiny" x-text="calculateDropoff(stats.funnel?.successful_signups, stats.funnel?.signup_attempts)"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Daily Trends Chart -->
            <div class="col-lg-8 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-graph-up-arrow me-2"></i>
                            Daily Trends
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="trendsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Preferences -->
            <div class="col-lg-4 mb-4">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-pie-chart me-2"></i>
                User Preferences
            </h5>
        </div>
        <div class="card-body">
            <!-- Check if we have mixed question types -->
            <div x-show="hasMixedQuestions()" class="mb-3">
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm"
                            @click="preferenceView = 'all'"
                            :class="{'active': preferenceView === 'all'}">
                        All Responses
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm"
                            @click="preferenceView = 'engagement'"
                            :class="{'active': preferenceView === 'engagement'}">
                        Follow-up
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm"
                            @click="preferenceView = 'app_intent'"
                            :class="{'active': preferenceView === 'app_intent'}">
                        App Usage
                    </button>
                </div>
            </div>

            <!-- All Preferences View -->
            <div x-show="preferenceView === 'all' || !hasMixedQuestions()">
                <!-- Original Engagement Preferences -->
                <div x-show="getPreferenceCount('nothing') > 0 || getPreferenceCount('notification') > 0 || getPreferenceCount('updates') > 0" class="mb-4">
                    <h6 class="text-muted mb-2">Follow-up Engagement</h6>

                    <div class="mb-3" x-show="getPreferenceCount('nothing') > 0">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Nothing</span>
                            <span class="badge bg-secondary" x-text="getPreferenceCount('nothing')"></span>
                        </div>
                        <div class="preference-bar mb-2">
                            <div class="preference-segment nothing" :style="'width: ' + getPreferencePercentage('nothing') + '%'"></div>
                        </div>
                    </div>

                    <div class="mb-3" x-show="getPreferenceCount('notification') > 0">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Notification Only</span>
                            <span class="badge bg-info" x-text="getPreferenceCount('notification')"></span>
                        </div>
                        <div class="preference-bar mb-2">
                            <div class="preference-segment notification" :style="'width: ' + getPreferencePercentage('notification') + '%'"></div>
                        </div>
                    </div>

                    <div class="mb-3" x-show="getPreferenceCount('updates') > 0">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Progress Updates</span>
                            <span class="badge bg-primary" x-text="getPreferenceCount('updates')"></span>
                        </div>
                        <div class="preference-bar mb-2">
                            <div class="preference-segment updates" :style="'width: ' + getPreferencePercentage('updates') + '%'"></div>
                        </div>
                    </div>
                </div>

                <!-- New App Usage Intent Preferences -->
                <div x-show="getPreferenceCount('yes_would_use') > 0 || getPreferenceCount('no_wouldnt_use') > 0 || getPreferenceCount('not_sure') > 0" class="mb-4">
                    <h6 class="text-muted mb-2">App Usage Intent</h6>

                    <div class="mb-3" x-show="getPreferenceCount('yes_would_use') > 0">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Yes, I would use</span>
                            <span class="badge bg-success" x-text="getPreferenceCount('yes_would_use')"></span>
                        </div>
                        <div class="preference-bar mb-2">
                            <div class="preference-segment yes-would-use" :style="'width: ' + getPreferencePercentage('yes_would_use') + '%'"></div>
                        </div>
                    </div>

                    <div class="mb-3" x-show="getPreferenceCount('not_sure') > 0">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">Not sure</span>
                            <span class="badge bg-warning" x-text="getPreferenceCount('not_sure')"></span>
                        </div>
                        <div class="preference-bar mb-2">
                            <div class="preference-segment not-sure" :style="'width: ' + getPreferencePercentage('not_sure') + '%'"></div>
                        </div>
                    </div>

                    <div class="mb-3" x-show="getPreferenceCount('no_wouldnt_use') > 0">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">No, I wouldn't</span>
                            <span class="badge bg-danger" x-text="getPreferenceCount('no_wouldnt_use')"></span>
                        </div>
                        <div class="preference-bar mb-2">
                            <div class="preference-segment no-wouldnt-use" :style="'width: ' + getPreferencePercentage('no_wouldnt_use') + '%'"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Engagement Follow-up Only View -->
            <div x-show="preferenceView === 'engagement'">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Nothing</span>
                        <span class="badge bg-secondary" x-text="getPreferenceCount('nothing')"></span>
                    </div>
                    <div class="preference-bar mb-3">
                        <div class="preference-segment nothing" :style="'width: ' + getEngagementPreferencePercentage('nothing') + '%'"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Notification Only</span>
                        <span class="badge bg-info" x-text="getPreferenceCount('notification')"></span>
                    </div>
                    <div class="preference-bar mb-3">
                        <div class="preference-segment notification" :style="'width: ' + getEngagementPreferencePercentage('notification') + '%'"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Progress Updates</span>
                        <span class="badge bg-primary" x-text="getPreferenceCount('updates')"></span>
                    </div>
                    <div class="preference-bar">
                        <div class="preference-segment updates" :style="'width: ' + getEngagementPreferencePercentage('updates') + '%'"></div>
                    </div>
                </div>
            </div>

            <!-- App Usage Intent Only View -->
            <div x-show="preferenceView === 'app_intent'">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Yes, I would use</span>
                        <span class="badge bg-success" x-text="getPreferenceCount('yes_would_use')"></span>
                    </div>
                    <div class="preference-bar mb-3">
                        <div class="preference-segment yes-would-use" :style="'width: ' + getAppIntentPercentage('yes_would_use') + '%'"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">Not sure</span>
                        <span class="badge bg-warning" x-text="getPreferenceCount('not_sure')"></span>
                    </div>
                    <div class="preference-bar mb-3">
                        <div class="preference-segment not-sure" :style="'width: ' + getAppIntentPercentage('not_sure') + '%'"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">No, I wouldn't</span>
                        <span class="badge bg-danger" x-text="getPreferenceCount('no_wouldnt_use')"></span>
                    </div>
                    <div class="preference-bar">
                        <div class="preference-segment no-wouldnt-use" :style="'width: ' + getAppIntentPercentage('no_wouldnt_use') + '%'"></div>
                    </div>
                </div>
            </div>

            <!-- Insights Section -->
            <div class="mt-4 pt-3 border-top">
                <div class="small text-muted">
                    <strong>Key Insight:</strong>
                    <span x-text="getPreferenceInsight()"></span>
                </div>
            </div>
        </div>
    </div>
</div>
        </div>

        <!-- Data Tables Row -->
        <div class="row">
            <!-- Traffic Sources -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-link-45deg me-2"></i>
                            Traffic Sources
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Source</th>
                                        <th class="text-end">Sessions</th>
                                        <th class="text-end">%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="source in stats.traffic_sources || []" :key="source.source">
                                        <tr>
                                            <td>
                                                <span class="badge badge-source" x-text="source.source || 'Direct'"></span>
                                            </td>
                                            <td class="text-end" x-text="formatNumber(source.count)"></td>
                                            <td class="text-end" x-text="((source.count / stats.overview?.total_sessions) * 100).toFixed(1) + '%'"></td>
                                        </tr>
                                    </template>
                                    <tr x-show="!stats.traffic_sources?.length && !loading">
                                        <td colspan="3" class="text-center text-muted">No traffic data available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Device Types -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-phone me-2"></i>
                            Device Types
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Device</th>
                                        <th class="text-end">Sessions</th>
                                        <th class="text-end">%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="device in stats.devices || []" :key="device.type">
                                        <tr>
                                            <td>
                                                <i class="bi" :class="{
                                                    'bi-phone': device.type === 'mobile',
                                                    'bi-tablet': device.type === 'tablet',
                                                    'bi-laptop': device.type === 'desktop',
                                                    'bi-question-circle': device.type === 'unknown'
                                                }"></i>
                                                <span class="ms-2" x-text="device.type.charAt(0).toUpperCase() + device.type.slice(1)"></span>
                                            </td>
                                            <td class="text-end" x-text="formatNumber(device.count)"></td>
                                            <td class="text-end" x-text="((device.count / stats.overview?.total_sessions) * 100).toFixed(1) + '%'"></td>
                                        </tr>
                                    </template>
                                    <tr x-show="!stats.devices?.length && !loading">
                                        <td colspan="3" class="text-center text-muted">No device data available</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        function dashboardApp() {
            return {
                stats: {},
                loading: true,
                dateRange: 30,
                trendsChart: null,
                preferenceView: 'all', // 'all', 'engagement', 'app_intent'

                async init() {
                    await this.loadStats();
                    this.initCharts();
                    // Refresh every 5 minutes
                    setInterval(() => this.loadStats(), 5 * 60 * 1000);
                },

                async loadStats() {
                    this.loading = true;
                    try {
                        const response = await fetch(`/api/dashboard-stats/?days=${this.dateRange}`);
                        this.stats = await response.json();
                        this.updateCharts();
                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                async changeDateRange(days) {
                    this.dateRange = days;
                    await this.loadStats();
                },

                async refreshData() {
                    await this.loadStats();
                },

                formatNumber(num) {
                    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                    return num.toString();
                },

                formatDateRange() {
                    if (!this.stats.date_range) return `Last ${this.dateRange} days`;
                    const start = new Date(this.stats.date_range.start).toLocaleDateString();
                    const end = new Date(this.stats.date_range.end).toLocaleDateString();
                    return `${start} - ${end}`;
                },

                calculateDropoff(current, previous) {
                    if (!previous || previous === 0) return '';
                    const percentage = ((current / previous) * 100).toFixed(1);
                    return `${percentage}%`;
                },

                getPreferencePercentage(type) {
                    const total = (this.stats.preferences?.nothing || 0) +
                                 (this.stats.preferences?.notification || 0) +
                                 (this.stats.preferences?.updates || 0);
                    if (total === 0) return 0;
                    return ((this.stats.preferences?.[type] || 0) / total * 100).toFixed(1);
                },

                getPreferenceInsight() {
                    const prefs = this.stats.preferences;
                    if (!prefs) return 'Loading insights...';

                    const total = (prefs.nothing || 0) + (prefs.notification || 0) + (prefs.updates || 0);
                    if (total === 0) return 'No survey data yet';

                    const updatesPct = ((prefs.updates || 0) / total * 100);
                    const notificationPct = ((prefs.notification || 0) / total * 100);

                    if (updatesPct > 50) return 'Users want active engagement!';
                    if (notificationPct > 40) return 'Users prefer simple notifications';
                    return 'Mixed engagement preferences';
                },

                // Updated preference handling functions
                getPreferenceCount(type) {
                    return this.stats.preferences?.[type] || 0;
                },

                getPreferencePercentage(type) {
                    const total = this.getTotalPreferences();
                    if (total === 0) return 0;
                    return ((this.stats.preferences?.[type] || 0) / total * 100).toFixed(1);
                },

                getEngagementPreferencePercentage(type) {
                    const engagementTypes = ['nothing', 'notification', 'updates'];
                    const total = engagementTypes.reduce((sum, pref) =>
                        sum + (this.stats.preferences?.[pref] || 0), 0);
                    if (total === 0) return 0;
                    return ((this.stats.preferences?.[type] || 0) / total * 100).toFixed(1);
                },

                getAppIntentPercentage(type) {
                    const appIntentTypes = ['yes_would_use', 'not_sure', 'no_wouldnt_use'];
                    const total = appIntentTypes.reduce((sum, pref) =>
                        sum + (this.stats.preferences?.[pref] || 0), 0);
                    if (total === 0) return 0;
                    return ((this.stats.preferences?.[type] || 0) / total * 100).toFixed(1);
                },

                getTotalPreferences() {
                    const prefs = this.stats.preferences;
                    if (!prefs) return 0;

                    return (prefs.nothing || 0) +
                           (prefs.notification || 0) +
                           (prefs.updates || 0) +
                           (prefs.yes_would_use || 0) +
                           (prefs.not_sure || 0) +
                           (prefs.no_wouldnt_use || 0);
                },

                hasMixedQuestions() {
                    const prefs = this.stats.preferences;
                    if (!prefs) return false;

                    const hasEngagement = (prefs.nothing || 0) + (prefs.notification || 0) + (prefs.updates || 0) > 0;
                    const hasAppIntent = (prefs.yes_would_use || 0) + (prefs.not_sure || 0) + (prefs.no_wouldnt_use || 0) > 0;

                    return hasEngagement && hasAppIntent;
                },

                getPreferenceInsight() {
                    const prefs = this.stats.preferences;
                    if (!prefs) return 'Loading insights...';

                    const total = this.getTotalPreferences();
                    if (total === 0) return 'No survey data yet';

                    // Check what type of data we have
                    const engagementTypes = ['nothing', 'notification', 'updates'];
                    const appIntentTypes = ['yes_would_use', 'not_sure', 'no_wouldnt_use'];

                    const engagementTotal = engagementTypes.reduce((sum, pref) =>
                        sum + (prefs[pref] || 0), 0);
                    const appIntentTotal = appIntentTypes.reduce((sum, pref) =>
                        sum + (prefs[pref] || 0), 0);

                    // If we have both types of responses
                    if (engagementTotal > 0 && appIntentTotal > 0) {
                        const yesWouldUse = ((prefs.yes_would_use || 0) / appIntentTotal * 100);
                        const updatesPreference = ((prefs.updates || 0) / engagementTotal * 100);

                        if (yesWouldUse > 60 && updatesPreference > 40) {
                            return 'High app interest + strong engagement preference';
                        } else if (yesWouldUse > 60) {
                            return 'Strong interest in using reporting app';
                        } else if (updatesPreference > 50) {
                            return 'Users want active engagement after reporting';
                        } else {
                            return 'Mixed responses across question types';
                        }
                    }

                    // If we only have app intent responses
                    if (appIntentTotal > 0 && engagementTotal === 0) {
                        const yesWouldUse = ((prefs.yes_would_use || 0) / appIntentTotal * 100);
                        const notSure = ((prefs.not_sure || 0) / appIntentTotal * 100);
                        const noWouldntUse = ((prefs.no_wouldnt_use || 0) / appIntentTotal * 100);

                        if (yesWouldUse > 70) return 'Strong market validation - high app adoption intent';
                        if (yesWouldUse > 50) return 'Positive market signal - good app interest';
                        if (notSure > 40) return 'High uncertainty - need clearer value prop';
                        if (noWouldntUse > 50) return 'Low adoption intent - address barriers';
                        return 'Mixed app usage interest';
                    }

                    // If we only have engagement responses (original question)
                    if (engagementTotal > 0 && appIntentTotal === 0) {
                        const updatesPct = ((prefs.updates || 0) / engagementTotal * 100);
                        const notificationPct = ((prefs.notification || 0) / engagementTotal * 100);
                        const nothingPct = ((prefs.nothing || 0) / engagementTotal * 100);

                        if (updatesPct > 50) return 'Users want active engagement!';
                        if (notificationPct > 40) return 'Users prefer simple notifications';
                        if (nothingPct > 60) return 'Low engagement - review value proposition';
                        return 'Mixed engagement preferences';
                    }

                    return 'Analyzing user preferences...';
                },

                initCharts() {
                    const ctx = document.getElementById('trendsChart').getContext('2d');
                    this.trendsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Sessions',
                                data: [],
                                borderColor: '#2B5CE6',
                                backgroundColor: 'rgba(43, 92, 230, 0.1)',
                                tension: 0.3,
                                fill: true
                            }, {
                                label: 'Signups',
                                data: [],
                                borderColor: '#10B981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0,0,0,0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(0,0,0,0.05)'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                }
                            }
                        }
                    });
                },

                updateCharts() {
                    if (!this.trendsChart || !this.stats.daily_trends) return;

                    const trends = this.stats.daily_trends;
                    this.trendsChart.data.labels = trends.map(t => new Date(t.date).toLocaleDateString());
                    this.trendsChart.data.datasets[0].data = trends.map(t => t.sessions);
                    this.trendsChart.data.datasets[1].data = trends.map(t => t.signups);
                    this.trendsChart.update();
                }
            }
        }
    </script>
</body>
</html>