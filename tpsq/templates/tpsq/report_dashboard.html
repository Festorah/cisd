<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Square Pretotype | Analytics Dashboard</title>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* CISD Brand Colors */
            --primary-blue: #2B5CE6;
            --primary-green: #0EA5E9;
            --accent-orange: #F97316;
            --accent-red: #EF4444;
            --dark-blue: #1E40AF;
            --light-blue: #DBEAFE;
            --success-green: #10B981;
            --success-light: #D1FAE5;

            /* Dashboard Colors */
            --bg-primary: #F8FAFC;
            --bg-secondary: #FFFFFF;
            --bg-accent: #F1F5F9;
            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-muted: #94A3B8;
            --border-color: #E2E8F0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);

            /* Typography */
            --font-heading: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* LAYOUT */
        .dashboard-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .dashboard-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .dashboard-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin: 0;
        }

        .dashboard-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-left: auto;
        }

        .date-range-selector {
            display: flex;
            gap: 0.5rem;
        }

        .date-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .date-btn:hover {
            background: var(--bg-accent);
        }

        .date-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .refresh-btn {
            padding: 0.5rem 1rem;
            background: var(--success-green);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .refresh-btn:hover {
            background: #059669;
        }

        /* MAIN CONTENT */
        .dashboard-main {
            flex: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* EXPERIMENT STATUS */
        .experiment-status {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-green));
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .experiment-status::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="2"/></svg>');
            transform: translate(25%, -25%);
        }

        .experiment-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .experiment-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .experiment-period {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .hypothesis-status {
            text-align: right;
        }

        .hypothesis-result {
            font-size: 2rem;
            font-weight: 900;
            line-height: 1;
        }

        .hypothesis-label {
            font-size: 0.75rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* METRICS GRID */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .metric-icon.primary { background: var(--primary-blue); }
        .metric-icon.success { background: var(--success-green); }
        .metric-icon.warning { background: var(--accent-orange); }
        .metric-icon.info { background: var(--primary-green); }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.25rem;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .metric-change {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .metric-change.positive { color: var(--success-green); }
        .metric-change.negative { color: var(--accent-red); }
        .metric-change.neutral { color: var(--text-muted); }

        /* CHARTS GRID */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container.tall {
            height: 400px;
        }

        /* INSIGHTS SECTION */
        .insights-section {
            margin-bottom: 2rem;
        }

        .insights-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .insights-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1rem;
        }

        .insight-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--primary-blue);
            border-radius: 6px;
            padding: 1rem;
        }

        .insight-card.success { border-left-color: var(--success-green); }
        .insight-card.warning { border-left-color: var(--accent-orange); }
        .insight-card.danger { border-left-color: var(--accent-red); }

        .insight-text {
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* DATA TABLES */
        .data-section {
            margin-bottom: 2rem;
        }

        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .data-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .export-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .export-select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
        }

        .export-select:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .data-export {
            padding: 0.5rem 1rem;
            background: var(--bg-accent);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .data-export:hover {
            background: var(--border-color);
        }

        .data-export:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .data-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-accent);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        td {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        tr:hover {
            background: var(--bg-accent);
        }

        /* STATUS BADGES */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.success {
            background: var(--success-light);
            color: var(--success-green);
        }

        .status-badge.warning {
            background: #FEF3E2;
            color: var(--accent-orange);
        }

        .status-badge.info {
            background: var(--light-blue);
            color: var(--primary-blue);
        }

        /* LOADING STATES */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .dashboard-header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .dashboard-main {
                padding: 1rem;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .experiment-header {
                flex-direction: column;
                gap: 1rem;
            }

            .hypothesis-status {
                text-align: left;
            }

            .export-controls {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
        }

        .chart-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            background: var(--bg-accent);
            border-radius: 8px;
            color: var(--text-muted);
            font-style: italic;
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- HEADER -->
        <header class="dashboard-header">
            <div class="header-content">
                <div>
                    <h1 class="dashboard-title">Public Square Pretotype Analytics</h1>
                    <p class="dashboard-subtitle">Real-time insights into civic engagement behavior</p>
                </div>

                <div class="header-controls">
                    <div class="date-range-selector">
                        <button class="date-btn" data-days="7">7 Days</button>
                        <button class="date-btn active" data-days="14">14 Days</button>
                        <button class="date-btn" data-days="30">30 Days</button>
                        <button class="date-btn" data-days="all">All</button>
                    </div>

                    <div class="export-controls">
                        <select id="exportType" class="export-select">
                            <option value="issues">Issues Data</option>
                            <option value="sessions">Sessions Data</option>
                            <option value="summary">Daily Summary</option>
                        </select>
                        <button class="data-export" onclick="exportData()">
                            <i class="fas fa-download"></i>
                            Export CSV
                        </button>
                    </div>

                    <button class="refresh-btn" id="refreshData">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="dashboard-main">
            <!-- EXPERIMENT STATUS -->
            <section class="experiment-status">
                <div class="experiment-header">
                    <div>
                        <h2 class="experiment-title">Experiment Status: Active</h2>
                        <p class="experiment-period" id="experimentPeriod">Running for 14 days</p>
                    </div>
                    <div class="hypothesis-status">
                        <div class="hypothesis-result" id="conversionRate">--</div>
                        <div class="hypothesis-label">Overall Conversion</div>
                    </div>
                </div>
            </section>

            <!-- KEY METRICS -->
            <section class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                    <div class="metric-value" id="totalSessions">--</div>
                    <div class="metric-label">Total Sessions</div>
                    <div class="metric-change positive" id="sessionsChange">
                        <i class="fas fa-arrow-up"></i>
                        <span>-- today</span>
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon info">
                            <i class="fas fa-mouse-pointer"></i>
                        </div>
                    </div>
                    <div class="metric-value" id="ctaClicks">--</div>
                    <div class="metric-label">CTA Clicks</div>
                    <div class="metric-change positive" id="ctaClickRate">
                        <span>--%</span> click rate
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon success">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                    <div class="metric-value" id="issuesReported">--</div>
                    <div class="metric-label">Issues Reported</div>
                    <div class="metric-change positive" id="issueSubmitRate">
                        <span>--%</span> submission rate
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon warning">
                            <i class="fas fa-envelope"></i>
                        </div>
                    </div>
                    <div class="metric-value" id="contactsCollected">--</div>
                    <div class="metric-label">Contact Details</div>
                    <div class="metric-change positive" id="contactRate">
                        <span>--%</span> contact rate
                    </div>
                </div>
            </section>

            <!-- CHARTS -->
            <section class="charts-grid">
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">Conversion Funnel</h3>
                            <p class="chart-subtitle">Step-by-step user journey analysis</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="funnelChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">Issue Types</h3>
                            <p class="chart-subtitle">What problems are people reporting?</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="issueTypesChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div>
                            <h3 class="chart-title">Daily Trends</h3>
                            <p class="chart-subtitle">Sessions and conversions over time</p>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>
            </section>

            <!-- INSIGHTS -->
            <section class="insights-section">
                <div class="insights-header">
                    <i class="fas fa-lightbulb" style="color: var(--accent-orange);"></i>
                    <h3 class="insights-title">Key Insights</h3>
                </div>
                <div class="insights-grid" id="insightsContainer">
                    <div class="insight-card">
                        <div class="insight-text">Loading insights...</div>
                    </div>
                </div>
            </section>

            <!-- DETAILED DATA -->
            <section class="data-section">
                <div class="data-header">
                    <h3 class="data-title">Recent Issues Reported</h3>
                </div>
                <div class="data-table">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Issue Type</th>
                                    <th>Details</th>
                                    <th>Has Image</th>
                                    <th>Device</th>
                                    <th>Source</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="issuesTableBody">
                                <tr>
                                    <td colspan="7" class="loading">
                                        <div class="spinner"></div>
                                        Loading recent issues...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Chart.js with proper loading sequence -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-date-fns/2.0.0/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        // Wait for Chart.js to load before initializing dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Verify Chart.js loaded properly
            if (typeof Chart === 'undefined') {
<!--                console.error('Chart.js failed to load');-->
                showChartError('Charts unavailable - Chart.js failed to load');
                return;
            }

            // Initialize dashboard
            window.dashboard = new PretotypeDashboard();
        });

        function showChartError(message) {
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                container.innerHTML = `<div class="chart-error">${message}</div>`;
            });
        }

        // Dashboard Analytics Class
        class PretotypeDashboard {
            constructor() {
                this.dateRange = 14; // Default to 14 days
                this.charts = {};
                this.refreshInterval = null;
                this.csrfToken = null;

                this.init();
            }

            async init() {
                // Get CSRF token first
                await this.getCSRFToken();
                this.setupEventListeners();
                await this.loadDashboardData();
                this.startAutoRefresh();
            }

            async getCSRFToken() {
                try {
                    const response = await fetch('/api/csrf-token/');
                    if (response.ok) {
                        const data = await response.json();
                        this.csrfToken = data.csrf_token;
                    }
                } catch (error) {
<!--                    console.warn('Could not get CSRF token:', error);-->
                    // Try to get from cookie as fallback
                    this.csrfToken = this.getCSRFFromCookie();
                }
            }

            getCSRFFromCookie() {
                const cookieValue = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('csrftoken='))
                    ?.split('=')[1];
                return cookieValue || null;
            }

            setupEventListeners() {
                // Date range selector - handle 'all' as string
                document.querySelectorAll('.date-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelector('.date-btn.active').classList.remove('active');
                        e.target.classList.add('active');
                        this.dateRange = e.target.dataset.days; // Keep as string to handle 'all'
                        this.loadDashboardData();
                    });
                });

                // Refresh button
                document.getElementById('refreshData').addEventListener('click', () => {
                    this.loadDashboardData();
                });
            }

            async loadDashboardData() {
                try {
                    // Show loading state
                    this.showLoadingState();

                    // Prepare headers
                    const headers = {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    };

                    // Add CSRF token if available
                    if (this.csrfToken) {
                        headers['X-CSRFToken'] = this.csrfToken;
                    }

                    // Make actual API call to your pretotype analytics endpoint
                    const response = await fetch(`/api/pretotype-analytics/?days=${this.dateRange}`, {
                        method: 'GET',
                        headers: headers,
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
                    }

                    const data = await response.json();

                    // Validate data structure
                    if (!data.summary || !data.funnel_steps || !data.issue_breakdown) {
                        throw new Error('Invalid data structure received from API');
                    }

                    this.updateMetrics(data);
                    this.updateCharts(data);
                    this.updateInsights(data);
                    this.updateIssuesTable(data);
                    this.updateExperimentStatus(data);

                    // Hide loading state
                    this.hideLoadingState();

                } catch (error) {
<!--                    console.error('Failed to load dashboard data:', error);-->
                    this.showError(`Failed to load analytics data: ${error.message}`);
                    this.hideLoadingState();
                }
            }

            showLoadingState() {
                // Add loading indicators to key sections
                document.getElementById('totalSessions').innerHTML = '<div class="spinner"></div>';
                document.getElementById('ctaClicks').innerHTML = '<div class="spinner"></div>';
                document.getElementById('issuesReported').innerHTML = '<div class="spinner"></div>';
                document.getElementById('contactsCollected').innerHTML = '<div class="spinner"></div>';

                // Show loading in insights
                document.getElementById('insightsContainer').innerHTML = `
                    <div class="insight-card">
                        <div class="insight-text">
                            <div class="spinner"></div> Loading insights...
                        </div>
                    </div>
                `;
            }

            hideLoadingState() {
                // Remove any lingering loading states - metrics will be updated by updateMetrics()
                // This is just a cleanup method in case of errors
            }

            updateMetrics(data) {
                const summary = data.summary;

                document.getElementById('totalSessions').textContent = this.formatNumber(summary.total_sessions);
                document.getElementById('ctaClicks').textContent = this.formatNumber(summary.cta_clicks);
                document.getElementById('issuesReported').textContent = this.formatNumber(summary.issues_submitted);
                document.getElementById('contactsCollected').textContent = this.formatNumber(summary.contacts_collected);

                // Update rates
                document.getElementById('ctaClickRate').innerHTML = `<span>${summary.cta_click_rate.toFixed(1)}%</span> click rate`;
                document.getElementById('issueSubmitRate').innerHTML = `<span>${summary.issue_submit_rate.toFixed(1)}%</span> submission rate`;
                document.getElementById('contactRate').innerHTML = `<span>${summary.contact_rate.toFixed(1)}%</span> contact rate`;

                // Update daily changes
                const todaySessions = data.daily_trends[data.daily_trends.length - 1]?.sessions || 0;
                document.getElementById('sessionsChange').innerHTML = `<i class="fas fa-arrow-up"></i><span>${todaySessions} today</span>`;
            }

            updateExperimentStatus(data) {
                const overallConversion = data.summary.overall_conversion;
                document.getElementById('conversionRate').textContent = `${overallConversion.toFixed(1)}%`;

                // Update experiment period - handle 'all' option
                const startDate = new Date(data.date_range.start);
                const endDate = new Date(data.date_range.end);
                const daysDiff = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));

                let periodText;
                if (this.dateRange === 'all') {
                    periodText = `Running for ${daysDiff} days total`;
                } else {
                    periodText = `Running for ${daysDiff} days`;
                }

                document.getElementById('experimentPeriod').textContent = periodText;
            }

            updateCharts(data) {
                try {
                    this.createFunnelChart(data.funnel_steps);
                    this.createIssueTypesChart(data.issue_breakdown);
                    this.createTrendsChart(data.daily_trends);
                } catch (error) {
<!--                    console.error('Error creating charts:', error);-->
                    showChartError('Error loading charts');
                }
            }

            createFunnelChart(funnelData) {
                const ctx = document.getElementById('funnelChart').getContext('2d');

                if (this.charts.funnel) {
                    this.charts.funnel.destroy();
                }

                const steps = ['Page Views', 'CTA Clicks', 'Issues Reported', 'Contact Info'];
                const values = [
                    funnelData.step_1,
                    funnelData.step_2,
                    funnelData.step_3,
                    funnelData.completed
                ];

                this.charts.funnel = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: steps,
                        datasets: [{
                            label: 'Users',
                            data: values,
                            backgroundColor: [
                                'rgba(43, 92, 230, 0.8)',
                                'rgba(14, 165, 233, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(249, 115, 22, 0.8)'
                            ],
                            borderColor: [
                                'rgb(43, 92, 230)',
                                'rgb(14, 165, 233)',
                                'rgb(16, 185, 129)',
                                'rgb(249, 115, 22)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        if (context.dataIndex > 0) {
                                            const prevValue = values[context.dataIndex - 1];
                                            const conversionRate = ((context.raw / prevValue) * 100).toFixed(1);
                                            return `${conversionRate}% conversion from previous step`;
                                        }
                                        return '';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            createIssueTypesChart(issueData) {
                const ctx = document.getElementById('issueTypesChart').getContext('2d');

                if (this.charts.issueTypes) {
                    this.charts.issueTypes.destroy();
                }

                const labels = Object.keys(issueData).map(key => key.charAt(0).toUpperCase() + key.slice(1));
                const values = Object.values(issueData);

                this.charts.issueTypes = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: [
                                '#2B5CE6',
                                '#0EA5E9',
                                '#10B981',
                                '#F97316',
                                '#EF4444',
                                '#8B5CF6',
                                '#F59E0B',
                                '#6B7280'
                            ],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = values.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.raw / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.raw} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            createTrendsChart(trendsData) {
                const ctx = document.getElementById('trendsChart').getContext('2d');

                if (this.charts.trends) {
                    this.charts.trends.destroy();
                }

                const labels = trendsData.map(item => new Date(item.date).toLocaleDateString());
                const sessions = trendsData.map(item => item.sessions);
                const issues = trendsData.map(item => item.issues);

                this.charts.trends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sessions',
                            data: sessions,
                            borderColor: 'rgb(43, 92, 230)',
                            backgroundColor: 'rgba(43, 92, 230, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Issues Reported',
                            data: issues,
                            borderColor: 'rgb(16, 185, 129)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            }
                        }
                    }
                });
            }

            updateInsights(data) {
                const insights = this.generateInsights(data);
                const container = document.getElementById('insightsContainer');

                container.innerHTML = insights.map(insight => `
                    <div class="insight-card ${insight.type}">
                        <div class="insight-text">${insight.text}</div>
                    </div>
                `).join('');
            }

            generateInsights(data) {
                const insights = [];
                const summary = data.summary;

                // Hypothesis validation
                if (summary.overall_conversion >= 5) {
                    insights.push({
                        type: 'success',
                        text: `Success! ${summary.overall_conversion.toFixed(1)}% conversion rate exceeds the 5% hypothesis target. This validates genuine interest in civic issue reporting.`
                    });
                } else {
                    insights.push({
                        type: 'warning',
                        text: `Current ${summary.overall_conversion.toFixed(1)}% conversion rate is below the 5% target. Consider optimizing the user experience or messaging.`
                    });
                }

                // CTA performance
                if (summary.cta_click_rate > 25) {
                    insights.push({
                        type: 'success',
                        text: `Strong initial engagement with ${summary.cta_click_rate.toFixed(1)}% CTA click rate indicates compelling messaging.`
                    });
                } else if (summary.cta_click_rate < 15) {
                    insights.push({
                        type: 'danger',
                        text: `Low CTA click rate (${summary.cta_click_rate.toFixed(1)}%) suggests the landing page needs optimization.`
                    });
                }

                // Device insights
                if (data.device_breakdown.mobile > data.device_breakdown.desktop) {
                    const mobilePercentage = ((data.device_breakdown.mobile / summary.total_sessions) * 100).toFixed(1);
                    insights.push({
                        type: 'info',
                        text: `Mobile users dominate (${mobilePercentage}%). Ensure mobile experience is optimized.`
                    });
                }

                return insights;
            }

            updateIssuesTable(data) {
                const tbody = document.getElementById('issuesTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: var(--text-muted); padding: 2rem;">
                            Detailed issue data available via API export
                        </td>
                    </tr>
                `;
            }

            formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                return num.toLocaleString();
            }

            startAutoRefresh() {
                // Refresh every 5 minutes
                this.refreshInterval = setInterval(() => {
                    this.loadDashboardData();
                }, 5 * 60 * 1000);
            }

            showError(message) {
                console.error(message);
                showChartError(message);
            }
        }

        // Enhanced Export function with better error handling
        function exportData() {
            const exportType = document.getElementById('exportType').value;
            const dateRange = window.dashboard ? window.dashboard.dateRange : '14';

<!--            console.log(`[EXPORT] Initiating export: type=${exportType}, range=${dateRange}`);-->

            // Show loading state on export button
            const exportBtn = document.querySelector('.data-export');
            const originalHTML = exportBtn.innerHTML;
            exportBtn.innerHTML = '<div class="spinner"></div> Exporting...';
            exportBtn.disabled = true;

            try {
                // Build export URL with debug parameters
                const url = `/api/pretotype-export/?format=csv&type=${exportType}&days=${dateRange}`;
<!--                console.log(`[EXPORT] URL: ${url}`);-->

                // Create and trigger download
                const link = document.createElement('a');
                link.href = url;
                link.download = '';
                link.style.display = 'none';

                // Add error handling for the download
                link.onerror = function() {
<!--                    console.error('[EXPORT] Download failed');-->
                    alert('Export download failed. Check console for details.');
                };

                document.body.appendChild(link);
                link.click();

                // Clean up
                setTimeout(() => {
                    document.body.removeChild(link);
                }, 1000);

<!--                console.log(`[EXPORT] Download initiated successfully`);-->

            } catch (error) {
<!--                console.error('[EXPORT] Export error:', error);-->
                alert('Export failed. Please check the console for details and try again.');
            }

            // Reset button state
            setTimeout(() => {
                exportBtn.innerHTML = originalHTML;
                exportBtn.disabled = false;
            }, 3000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (window.dashboard && window.dashboard.refreshInterval) {
                clearInterval(window.dashboard.refreshInterval);
            }
        });
    </script>
</body>

</html>