{% extends 'dashboard/base.html' %}

{% block title %}All Articles - CISD Dashboard{% endblock %}
{% block breadcrumb %}All Articles{% endblock %}

{% block content %}
<div x-data="articlesManager()" x-init="init()">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">All Articles</h1>
            <p class="text-muted">Manage and organize your content</p>
        </div>
        <div>
            <a href="{% url 'dashboard:article_create' %}" class="btn btn-primary-custom">
                <i class="fas fa-plus me-2"></i>New Article
            </a>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control" 
                               x-model="filters.search" 
                               placeholder="Search articles..."
                               @input="debounceSearch()">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" x-model="filters.status" @change="applyFilters()">
                        <option value="">All Status</option>
                        <option value="draft">Draft</option>
                        <option value="review">Under Review</option>
                        <option value="published">Published</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="archived">Archived</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" x-model="filters.category" @change="applyFilters()">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.display_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" x-model="filters.author" @change="applyFilters()">
                        <option value="">All Authors</option>
                        {% for author in authors %}
                        <option value="{{ author.id }}">{{ author.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" @click="clearFilters()">
                        <i class="fas fa-times me-2"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="card mb-4" x-show="selectedArticles.length > 0" x-transition>
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong x-text="selectedArticles.length"></strong> article(s) selected
                </div>
                <div>
                    <button class="btn btn-sm btn-success me-2" @click="bulkAction('publish')">
                        <i class="fas fa-globe me-1"></i>Publish
                    </button>
                    <button class="btn btn-sm btn-warning me-2" @click="bulkAction('draft')">
                        <i class="fas fa-edit me-1"></i>Draft
                    </button>
                    <button class="btn btn-sm btn-secondary me-2" @click="bulkAction('archive')">
                        <i class="fas fa-archive me-1"></i>Archive
                    </button>
                    <button class="btn btn-sm btn-danger" @click="bulkAction('delete')">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Articles Table -->
    <div class="card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="40">
                            <input type="checkbox" 
                                   class="form-check-input" 
                                   @change="toggleAllArticles($event.target.checked)">
                        </th>
                        <th>Title</th>
                        <th width="120">Status</th>
                        <th width="150">Category</th>
                        <th width="150">Author</th>
                        <th width="120">Views</th>
                        <th width="150">Last Modified</th>
                        <th width="150">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for article in articles %}
                    <tr>
                        <td>
                            <input type="checkbox" 
                                   class="form-check-input" 
                                   value="{{ article.id }}"
                                   @change="toggleArticleSelection('{{ article.id }}', $event.target.checked)">
                        </td>
                        <td>
                            <div>
                                <div class="fw-semibold">
                                    {{ article.title|truncatechars:60 }}
                                    {% if article.is_featured %}
                                    <span class="badge bg-warning text-dark ms-1">Featured</span>
                                    {% endif %}
                                    {% if article.is_breaking %}
                                    <span class="badge bg-danger ms-1">Breaking</span>
                                    {% endif %}
                                </div>
                                <small class="text-muted">{{ article.excerpt|truncatechars:80 }}</small>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-{% if article.status == 'published' %}success{% elif article.status == 'draft' %}warning{% elif article.status == 'review' %}info{% elif article.status == 'scheduled' %}primary{% else %}secondary{% endif %}">
                                {{ article.get_status_display }}
                            </span>
                        </td>
                        <td>
                            <span class="badge" style="background-color: {{ article.category.color_code }}">
                                {{ article.category.display_name }}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary rounded-circle text-white text-center me-2" 
                                     style="width: 32px; height: 32px; line-height: 32px; font-size: 0.75rem;">
                                    {{ article.author.name|slice:":2"|upper }}
                                </div>
                                <div>
                                    <div class="fw-medium">{{ article.author.name }}</div>
                                    {% if article.author.title %}
                                    <small class="text-muted">{{ article.author.title }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="fw-medium">{{ article.view_count|floatformat:0 }}</span>
                            {% if article.share_count %}
                            <br><small class="text-muted">{{ article.share_count }} shares</small>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                {{ article.updated_at|timesince }} ago
                            </div>
                            {% if article.published_date %}
                            <small class="text-muted">
                                Published: {{ article.published_date|date:"M d, Y" }}
                            </small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{% url 'dashboard:article_edit' article.id %}" 
                                   class="btn btn-sm btn-outline-primary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% if article.status == 'published' %}
                                <a href="{% url 'article_detail' article.slug %}" 
                                   class="btn btn-sm btn-outline-secondary" 
                                   target="_blank" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-info dropdown-toggle" 
                                        data-bs-toggle="dropdown" title="More">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" @click="duplicateArticle('{{ article.id }}')">
                                        <i class="fas fa-copy me-2"></i>Duplicate
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" @click="toggleFeatured('{{ article.id }}', {{ article.is_featured|yesno:'false,true' }})">
                                        <i class="fas fa-star me-2"></i>
                                        {% if article.is_featured %}Remove Featured{% else %}Make Featured{% endif %}
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" @click="deleteArticle('{{ article.id }}')">
                                        <i class="fas fa-trash me-2"></i>Delete
                                    </a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="text-muted">
                                <i class="fas fa-file-alt fa-3x mb-3"></i>
                                <h5>No Articles Found</h5>
                                <p>Try adjusting your filters or <a href="{% url 'dashboard:article_create' %}">create a new article</a></p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if articles.has_other_pages %}
        <div class="card-footer">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    {% if articles.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ articles.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                            Previous
                        </a>
                    </li>
                    {% endif %}

                    {% for num in articles.paginator.page_range %}
                    {% if articles.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% else %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                            {{ num }}
                        </a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if articles.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ articles.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">
                            Next
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function articlesManager() {
        return {
            filters: {
                search: '{{ request.GET.search|default:"" }}',
                status: '{{ request.GET.status|default:"" }}',
                category: '{{ request.GET.category|default:"" }}',
                author: '{{ request.GET.author|default:"" }}'
            },
            
            selectedArticles: [],
            searchTimeout: null,
            services: null,

            async init() {
                await this.waitForServices();
                console.log('Articles manager initialized');
            },

            async waitForServices(maxAttempts = 10, delay = 100) {
                for (let i = 0; i < maxAttempts; i++) {
                    if (window.dashboardServices) {
                        this.services = window.dashboardServices;
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
                this.createFallbackServices();
            },

            createFallbackServices() {
                this.services = {
                    http: {
                        async post(url, data) {
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': this.getCSRFToken()
                                },
                                body: JSON.stringify(data)
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return await response.json();
                        },
                        
                        getCSRFToken() {
                            return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                   document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
                        }
                    },
                    
                    notifications: {
                        success: (msg) => this.showNotification(msg, 'success'),
                        error: (msg) => this.showNotification(msg, 'danger'),
                        warning: (msg) => this.showNotification(msg, 'warning'),
                        info: (msg) => this.showNotification(msg, 'info')
                    }
                };
            },

            debounceSearch() {
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    this.applyFilters();
                }, 500);
            },

            applyFilters() {
                const params = new URLSearchParams();
                
                Object.keys(this.filters).forEach(key => {
                    if (this.filters[key]) {
                        params.set(key, this.filters[key]);
                    }
                });

                const url = new URL(window.location.href);
                url.search = params.toString();
                window.location.href = url.toString();
            },

            clearFilters() {
                this.filters = {
                    search: '',
                    status: '',
                    category: '',
                    author: ''
                };
                window.location.href = window.location.pathname;
            },

            toggleArticleSelection(articleId, checked) {
                if (checked) {
                    if (!this.selectedArticles.includes(articleId)) {
                        this.selectedArticles.push(articleId);
                    }
                } else {
                    this.selectedArticles = this.selectedArticles.filter(id => id !== articleId);
                }
            },

            toggleAllArticles(checked) {
                const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = checked;
                    this.toggleArticleSelection(checkbox.value, checked);
                });
            },

            async bulkAction(action) {
                if (this.selectedArticles.length === 0) {
                    this.services.notifications.warning('Please select articles first');
                    return;
                }

                const actionText = {
                    publish: 'publish',
                    draft: 'move to draft',
                    archive: 'archive',
                    delete: 'delete'
                };

                if (!confirm(`Are you sure you want to ${actionText[action]} ${this.selectedArticles.length} article(s)?`)) {
                    return;
                }

                try {
                    const response = await this.services.http.post('/dashboard/ajax/bulk-articles/', {
                        article_ids: this.selectedArticles,
                        action: action
                    });

                    if (response.success) {
                        this.services.notifications.success(`Successfully ${actionText[action]}ed ${this.selectedArticles.length} article(s)`);
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        throw new Error(response.error || `Failed to ${action} articles`);
                    }
                } catch (error) {
                    this.services.notifications.error(`Error: ${error.message}`);
                }
            },

            async deleteArticle(articleId) {
                if (!confirm('Are you sure you want to delete this article? This action cannot be undone.')) {
                    return;
                }

                try {
                    const response = await this.services.http.post(`/dashboard/ajax/delete-article/${articleId}/`, {
                        action: 'delete'
                    });

                    if (response.success) {
                        this.services.notifications.success('Article deleted successfully');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        throw new Error(response.error || 'Failed to delete article');
                    }
                } catch (error) {
                    this.services.notifications.error(`Error deleting article: ${error.message}`);
                }
            },

            async toggleFeatured(articleId, makeFeatured) {
                try {
                    const response = await this.services.http.post(`/dashboard/ajax/toggle-featured/${articleId}/`, {
                        is_featured: makeFeatured
                    });

                    if (response.success) {
                        this.services.notifications.success(makeFeatured ? 'Article marked as featured' : 'Article removed from featured');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        throw new Error(response.error || 'Failed to update article');
                    }
                } catch (error) {
                    this.services.notifications.error(`Error: ${error.message}`);
                }
            },

            async duplicateArticle(articleId) {
                try {
                    const response = await this.services.http.post(`/dashboard/ajax/duplicate-article/${articleId}/`, {
                        action: 'duplicate'
                    });

                    if (response.success) {
                        this.services.notifications.success('Article duplicated successfully');
                        setTimeout(() => {
                            window.location.href = `/dashboard/article/${response.new_article_id}/edit/`;
                        }, 1000);
                    } else {
                        throw new Error(response.error || 'Failed to duplicate article');
                    }
                } catch (error) {
                    this.services.notifications.error(`Error duplicating article: ${error.message}`);
                }
            },

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                
                const icons = {
                    success: 'check-circle',
                    danger: 'exclamation-triangle',
                    warning: 'exclamation-circle',
                    info: 'info-circle'
                };
                
                notification.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-${icons[type] || 'info-circle'} me-2"></i>
                        <span>${message}</span>
                    </div>
                    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 5000);
            }
        }
    }
</script>
{% endblock %}