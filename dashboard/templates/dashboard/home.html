{% extends 'dashboard/base.html' %}

{% block title %}Dashboard - CISD{% endblock %}
{% block breadcrumb %}Dashboard{% endblock %}

{% block content %}
<div x-data="dashboardHome()" x-init="init()">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1">Dashboard Overview</h1>
            <p class="text-muted">Monitor your website performance and content status</p>
        </div>
        <div>
            <button class="btn btn-primary-custom" @click="refreshStats()">
                <i class="fas fa-sync-alt me-2"></i>Refresh Data
            </button>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-label">Total Articles</div>
                <div class="stat-value" x-text="stats.articles?.total || 0"></div>
                <small class="text-muted">
                    <span x-text="stats.articles?.this_month || 0"></span> this month
                </small>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-label">Published Articles</div>
                <div class="stat-value" x-text="stats.articles?.published || 0"></div>
                <small class="text-muted">
                    <span x-text="stats.articles?.draft || 0"></span> drafts pending
                </small>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-label">Total Views</div>
                <div class="stat-value" x-text="formatNumber(stats.content?.total_views || 0)"></div>
                <small class="text-muted">All time</small>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="stat-card">
                <div class="stat-label">Subscribers</div>
                <div class="stat-value" x-text="formatNumber(stats.users?.total_subscribers || 0)"></div>
                <small class="text-muted">
                    +<span x-text="stats.users?.new_subscribers || 0"></span> new
                </small>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row g-4">
        <!-- Recent Articles -->
        <div class="col-lg-8">
            <div class="dashboard-card">
                <div class="card-header p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Recent Articles</h5>
                        <a href="{% url 'dashboard:article_create' %}" class="btn btn-primary-custom btn-sm">
                            <i class="fas fa-plus me-2"></i>New Article
                        </a>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Title</th>
                                <th>Status</th>
                                <th>Author</th>
                                <th>Modified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for article in recent_articles %}
                            <tr>
                                <td>
                                    <div class="fw-semibold">{{ article.title|truncatechars:50 }}</div>
                                    <small class="text-muted">{{ article.category.display_name }}</small>
                                </td>
                                <td>
                                    <span
                                        class="badge bg-{% if article.status == 'published' %}success{% elif article.status == 'draft' %}warning{% else %}secondary{% endif %}">
                                        {{ article.get_status_display }}
                                    </span>
                                </td>
                                <td>{{ article.author.name }}</td>
                                <td>
                                    <small class="text-muted">{{ article.updated_at|timesince }} ago</small>
                                </td>
                                <td>
                                    <a href="{% url 'dashboard:article_edit' article.id %}"
                                        class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% if article.status == 'published' %}
                                    <a href="{% url 'article_detail' article.slug %}"
                                        class="btn btn-sm btn-outline-secondary" target="_blank">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                                        <p>No articles yet. <a href="{% url 'dashboard:article_create' %}">Create your
                                                first article</a></p>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Quick Stats & Actions -->
        <div class="col-lg-4">
            <!-- Quick Actions -->
            <div class="dashboard-card mb-4">
                <div class="card-header p-3 border-bottom">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body p-3">
                    <div class="d-grid gap-2">
                        <a href="{% url 'dashboard:article_create' %}" class="btn btn-primary-custom">
                            <i class="fas fa-plus me-2"></i>Create Article
                        </a>
                        <a href="{% url 'dashboard:media_library' %}" class="btn btn-outline-primary">
                            <i class="fas fa-upload me-2"></i>Upload Media
                        </a>
                        <button class="btn btn-outline-secondary" @click="exportData()">
                            <i class="fas fa-download me-2"></i>Export Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Content Status -->
            <div class="dashboard-card">
                <div class="card-header p-3 border-bottom">
                    <h5 class="mb-0">Content Status</h5>
                </div>
                <div class="card-body p-3">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small">Published</span>
                            <span class="small fw-semibold" x-text="stats.articles?.published || 0"></span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-success"
                                :style="`width: ${getPercentage(stats.articles?.published, stats.articles?.total)}%`">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small">Drafts</span>
                            <span class="small fw-semibold" x-text="stats.articles?.draft || 0"></span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-warning"
                                :style="`width: ${getPercentage(stats.articles?.draft, stats.articles?.total)}%`"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small">Under Review</span>
                            <span class="small fw-semibold" x-text="stats.articles?.review || 0"></span>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-info"
                                :style="`width: ${getPercentage(stats.articles?.review, stats.articles?.total)}%`">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function dashboardHome() {
        return {
            stats: {
                articles: {{ stats.articles | safe }
    },
    content: { { stats.content | safe } },
    users: { { stats.users | safe } },
    media: { { stats.media | safe } },
    events: { { stats.events | safe } }
        },

    init() {
        console.log('Dashboard home initialized');
    },

    formatNumber(num) {
        return num.toLocaleString();
    },

    getPercentage(value, total) {
        if (!total || total === 0) return 0;
        return Math.round((value / total) * 100);
    },
        
        async refreshStats() {
        try {
            const response = await fetch('/dashboard/ajax/stats/', {
                headers: {
                    'X-CSRFToken': this.getCSRFToken(),
                }
            });
            const data = await response.json();

            if (data.success) {
                this.stats = data.stats;
                this.showSuccess('Statistics refreshed successfully');
            }
        } catch (error) {
            this.showError('Error refreshing stats: ' + error.message);
            console.error('Error refreshing stats:', error);
        }
    },

    exportData() {
        // Implement data export functionality
        this.showSuccess('Export functionality coming soon!');
    },

    getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
            document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
    },

    showSuccess(message) {
        this.showNotification(message, 'success');
    },

    showError(message) {
        this.showNotification(message, 'danger');
    },

    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }
    }
}
</script>
{% endblock %}