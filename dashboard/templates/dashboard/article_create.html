<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Editor - CISD Dashboard</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
        rel="stylesheet">

    <!-- CSRF Token -->
    <meta name="csrf-token" content="{{ csrf_token }}">

    <style>
        :root {
            --wp-admin-theme-color: #0EA5E9;
            --wp-admin-theme-color-darker: #0284C7;
            --analysis-color: #dc2626;
            --campaign-color: #059669;
            --explainer-color: #7c3aed;
            --qna-color: #ea580c;
            --news-color: #0284c7;
            --research-color: #7c2d12;
        }

        body {
            background-color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .dashboard-header {
            background: #1e293b;
            color: #fff;
            padding: 1rem 0;
        }

        .editor-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .editor-main {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .editor-header {
            background: linear-gradient(135deg, #0EA5E9 0%, #0284C7 100%);
            color: white;
            padding: 1.5rem 2rem;
        }

        .article-title-input {
            border: none;
            outline: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.8rem;
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 1rem;
        }

        .article-title-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .article-title-input:focus {
            background: rgba(255, 255, 255, 0.2);
        }

        .article-meta-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-draft {
            background: #fef3c7;
            color: #92400e;
        }

        .status-review {
            background: #ddd6fe;
            color: #5b21b6;
        }

        .status-published {
            background: #d1fae5;
            color: #065f46;
        }

        .status-scheduled {
            background: #bfdbfe;
            color: #1e40af;
        }

        /* Enhanced Image Block Styles - Replace inline styles with CSS classes */
        .editor-image-block {
            margin: 2rem 0;
            text-align: center;
            position: relative;
            clear: both;
            display: block;
            width: 100%;
        }

        .editor-image-block img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: move;
        }

        .editor-image-block img:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .editor-image-caption {
            font-size: 0.875rem;
            color: #6b7280;
            font-style: italic;
            margin-top: 0.75rem;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background-color 0.3s ease;
            outline: none;
        }

        .editor-image-caption:hover {
            background-color: #f9fafb;
        }

        .editor-image-caption:focus {
            background-color: #f0f9ff;
            outline: 2px solid var(--wp-admin-theme-color);
            outline-offset: 2px;
        }

        .editor-image-caption[data-placeholder]:empty::before {
            content: attr(data-placeholder);
            color: #9ca3af;
            font-style: italic;
        }

        /* Image controls */
        .image-controls {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: none;
            gap: 0.25rem;
            z-index: 10;
        }

        .editor-image-block:hover .image-controls {
            display: flex;
        }

        .image-control-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.3s ease;
        }

        .image-control-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        /* Drag and drop enhancements */
        .editor-image-block.dragging {
            opacity: 0.5;
            transform: rotate(2deg) scale(0.95);
        }

        .main-editor.drag-over {
            background-color: #f0f9ff;
        }

        /* Cursor indicator */
        .cursor-indicator {
            position: absolute;
            width: 2px;
            height: 20px;
            background: var(--wp-admin-theme-color);
            animation: blink 1s infinite;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Enhanced Toolbar */
        .enhanced-toolbar {
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .toolbar-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .toolbar-row:last-child {
            margin-bottom: 0;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding-right: 0.75rem;
            border-right: 1px solid #d1d5db;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid transparent;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            color: #374151;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .toolbar-btn:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }

        .toolbar-btn.active {
            background: var(--wp-admin-theme-color);
            color: white;
            border-color: var(--wp-admin-theme-color);
        }

        .color-picker {
            width: 32px;
            height: 32px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            padding: 0;
        }

        /* Insert Content Dropdown */
        .insert-content-dropdown {
            position: relative;
        }

        .insert-dropdown-btn {
            background: var(--wp-admin-theme-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .insert-dropdown-btn:hover {
            background: var(--wp-admin-theme-color-darker);
        }

        .insert-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 280px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .insert-dropdown-menu.show {
            display: block;
        }

        .insert-section {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .insert-section:last-child {
            border-bottom: none;
        }

        .insert-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .insert-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.25rem;
        }

        .insert-option:hover {
            background: #f3f4f6;
        }

        .insert-option-icon {
            width: 32px;
            height: 32px;
            background: #f0f9ff;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--wp-admin-theme-color);
            font-size: 1.1rem;
        }

        .insert-option-content h6 {
            margin: 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }

        .insert-option-content small {
            color: #6b7280;
            font-size: 0.75rem;
        }

        /* Main Editor */
        .main-editor {
            min-height: 600px;
            padding: 2rem;
            font-size: 1rem;
            line-height: 1.7;
            outline: none;
            border: none;
            background: white;
            color: #374151;
        }

        .main-editor:focus {
            outline: none;
        }

        .main-editor p {
            margin-bottom: 1.2rem;
        }

        .main-editor h1,
        .main-editor h2,
        .main-editor h3,
        .main-editor h4,
        .main-editor h5,
        .main-editor h6 {
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .main-editor h1 {
            font-size: 2rem;
        }

        .main-editor h2 {
            font-size: 1.75rem;
        }

        .main-editor h3 {
            font-size: 1.5rem;
        }

        .main-editor h4 {
            font-size: 1.25rem;
        }

        /* Formatted text in editor */
        .main-editor strong {
            font-weight: 700;
            color: #1f2937;
        }

        .main-editor em {
            font-style: italic;
        }

        .main-editor a {
            color: #0EA5E9;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.3s ease;
        }

        .main-editor a:hover {
            border-bottom-color: #0EA5E9;
        }

        .main-editor u {
            text-decoration: underline;
        }

        .main-editor s {
            text-decoration: line-through;
        }

        /* Special Content Blocks */
        .quote-block {
            background: #f9fafb;
            border-left: 4px solid #6b7280;
            padding: 1.5rem;
            margin: 1.5rem 0;
            font-style: italic;
            font-size: 1.125rem;
            border-radius: 0 8px 8px 0;
        }

        .interview-block {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .interview-q {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .interview-a {
            margin-bottom: 1rem;
        }

        .callout-block {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .callout-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.75rem;
        }

        /* Publication Date Field */
        .publication-date-field {
            margin-bottom: 1rem;
        }

        .publication-date-field label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .publication-date-field input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem;
            border-radius: 6px;
            width: 100%;
        }

        .publication-date-field input:focus {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            outline: none;
        }

        .image-block {
            margin: 2rem 0;
            text-align: center;
        }

        .image-block img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .image-caption {
            font-size: 0.875rem;
            color: #6b7280;
            font-style: italic;
            margin-top: 0.75rem;
        }

        .video-block,
        .audio-block {
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 8px;
            text-align: center;
        }

        .media-placeholder {
            padding: 2rem;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            color: #6b7280;
        }

        /* Excerpt Area */
        .excerpt-area {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            background: #fafbfc;
        }

        .excerpt-input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.875rem;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
        }

        .excerpt-input:focus {
            outline: none;
            border-color: var(--wp-admin-theme-color);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            height: fit-content;
        }

        .sidebar-section {
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-header {
            background: #f8fafc;
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-content {
            padding: 1.5rem;
        }

        .media-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .media-upload-area:hover {
            border-color: var(--wp-admin-theme-color);
            background: #f0f9ff;
        }

        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .category-analysis {
            background: var(--analysis-color);
            color: white;
        }

        .category-campaign {
            background: var(--campaign-color);
            color: white;
        }

        .category-explainer {
            background: var(--explainer-color);
            color: white;
        }

        .category-qna {
            background: var(--qna-color);
            color: white;
        }

        .category-news {
            background: var(--news-color);
            color: white;
        }

        .category-research {
            background: var(--research-color);
            color: white;
        }

        /* Custom styling for add buttons */
        .btn-add-new {
            background: var(--wp-admin-theme-color) !important;
            border: 1px solid white !important;
            color: white !important;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .btn-add-new:hover {
            background: var(--wp-admin-theme-color-darker) !important;
            border-color: white !important;
            color: white !important;
            transform: scale(1.05);
        }

        .btn-add-new i {
            font-size: 0.8rem;
            color: white !important;
        }

        .btn-add-new:hover i {
            color: white !important;
        }

        /* Ensure the flex container styling */
        .d-flex {
            display: flex !important;
        }

        .align-items-center {
            align-items: center !important;
        }

        .me-2 {
            margin-right: 0.5rem !important;
        }

        .gap-2 {
            gap: 0.5rem !important;
        }

        /* Action Buttons */
        .action-buttons {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 1rem 2rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn-primary {
            background: var(--wp-admin-theme-color);
            border-color: var(--wp-admin-theme-color);
        }

        .btn-primary:hover {
            background: var(--wp-admin-theme-color-darker);
            border-color: var(--wp-admin-theme-color-darker);
        }

        /* Word count info */
        .word-count-info {
            position: absolute;
            bottom: 1rem;
            right: 2rem;
            font-size: 0.875rem;
            color: #6b7280;
            background: rgba(248, 250, 252, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }

        /* Enhanced Media Library Styles */
        .media-item.selected {
            border-color: var(--wp-admin-theme-color) !important;
            background-color: rgba(14, 165, 233, 0.1);
        }

        .upload-progress-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }

        .upload-progress-item.success {
            background: #d1e7dd;
            border-color: #badbcc;
        }

        .upload-progress-item.error {
            background: #f8d7da;
            border-color: #f5c2c7;
        }

        .progress-bar-custom {
            height: 6px;
            border-radius: 3px;
            background: #e9ecef;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--wp-admin-theme-color), var(--wp-admin-theme-color-darker));
            transition: width 0.3s ease;
        }

        .optimization-badge {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            display: inline-block;
            margin-left: 0.5rem;
        }

        /* Drag and Drop Enhancement */
        .modal-content.dragover {
            background: rgba(14, 165, 233, 0.05);
            border: 2px dashed var(--wp-admin-theme-color);
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1050;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        @media (max-width: 1024px) {
            .article-meta-row {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .toolbar-row {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-group {
                border-right: none;
                border-bottom: 1px solid #d1d5db;
                padding-bottom: 0.5rem;
                margin-bottom: 0.5rem;
            }
        }

        @media (max-width: 768px) {
            .editor-container {
                padding: 1rem;
            }

            .main-editor {
                padding: 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <a href="/dashboard/" style="color: white; text-decoration: none;">
                        <i class="bi bi-arrow-left me-2"></i>
                        Article Editor
                    </a>
                </h4>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-light">Auto-saved <span id="autoSaveTime">just now</span></span>
                    <button class="btn btn-outline-light btn-sm" onclick="previewArticle()">
                        <i class="bi bi-eye me-1"></i> Preview Article
                    </button>
                    <small class="text-light opacity-75">Preview opens in new tab</small>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid editor-container">
        <div class="row">
            <!-- Main Editor Column -->
            <div class="col-lg-8">
                <div class="editor-main">
                    <!-- Article Header -->
                    <div class="editor-header">
                        <input type="text" id="articleTitle" class="article-title-input"
                            placeholder="Enter your article title here..." oninput="updateWordCount(); autoSave()">

                        <!-- Publication Date Field -->
                        <div class="publication-date-field">
                            <label for="publicationDate">Publication Date</label>
                            <input type="datetime-local" id="publicationDate" onchange="autoSave()">
                        </div>

                        <div class="article-meta-row">
                            <div class="d-flex align-items-center">
                                <select id="articleCategory" class="form-select me-2" onchange="updateCategoryBadge(); autoSave()">
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.display_name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-add-new" onclick="openCategoryModal()" title="Add New Category">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>

                            <div class="d-flex align-items-center">
                                <select id="articleAuthor" class="form-select me-2" onchange="autoSave()">
                                    <option value="">Select Author</option>
                                    {% for author in authors %}
                                    <option value="{{ author.id }}" {% if author.user_id == request.user.id %}selected{% endif %}>{{ author.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-add-new" onclick="openAuthorModal()" title="Add New Author">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>

                            <select id="articleStatus" class="form-select" onchange="updateStatusBadge(); autoSave()">
                                <option value="draft">Draft</option>
                                <option value="review">Under Review</option>
                                <option value="scheduled">Scheduled</option>
                                <option value="published">Published</option>
                            </select>

                            <span class="status-badge status-draft" id="statusBadge">DRAFT</span>
                        </div>

                    </div>

                    <!-- Article Excerpt -->
                    <div class="excerpt-area">
                        <label class="form-label fw-semibold text-muted">Article Excerpt</label>
                        <textarea id="articleExcerpt" class="excerpt-input" rows="3" maxlength="500"
                            placeholder="Write a compelling excerpt that summarizes your article..."
                            oninput="updateWordCount(); autoSave()"></textarea>
                        <small class="text-muted">
                            <span id="excerptCount">0</span>/500 characters
                        </small>
                    </div>

                    <!-- Enhanced Toolbar -->
                    <div class="enhanced-toolbar">
                        <!-- First Row - Text Formatting -->
                        <div class="toolbar-row">
                            <div class="toolbar-group">
                                <button class="toolbar-btn" onclick="execCommand('undo')" title="Undo">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('redo')" title="Redo">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <button class="toolbar-btn" onclick="execCommand('bold')" title="Bold (Ctrl+B)">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('italic')" title="Italic (Ctrl+I)">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('underline')"
                                    title="Underline (Ctrl+U)">
                                    <i class="bi bi-type-underline"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('strikethrough')"
                                    title="Strikethrough">
                                    <i class="bi bi-type-strikethrough"></i>
                                </button>
                                <button class="toolbar-btn" onclick="insertQuote()"
                                    title="Quote - Works with selected text (Ctrl+Q)">
                                    <i class="bi bi-quote"></i>
                                </button>
                                <button class="toolbar-btn" onclick="insertCallout()"
                                    title="Callout - Works with selected text">
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <!-- Font Size -->
                                <select class="form-select form-select-sm font-size-select" onchange="changeFontSize(this.value)" title="Font Size">
                                    <option value="">Size</option>
                                    <option value="10px">10px</option>
                                    <option value="12px">12px</option>
                                    <option value="14px">14px</option>
                                    <option value="16px">16px</option>
                                    <option value="18px">18px</option>
                                    <option value="20px">20px</option>
                                    <option value="24px">24px</option>
                                    <option value="28px">28px</option>
                                    <option value="32px">32px</option>
                                </select>

                                <!-- Line Spacing -->
                                <select class="form-select form-select-sm line-spacing-select" onchange="changeLineHeight(this.value)" title="Line Spacing">
                                    <option value="">Spacing</option>
                                    <option value="1">1.0</option>
                                    <option value="1.15">1.15</option>
                                    <option value="1.5">1.5</option>
                                    <option value="2">2.0</option>
                                    <option value="2.5">2.5</option>
                                    <option value="3">3.0</option>
                                </select>
                            </div>

                            <div class="toolbar-group">
                                <input type="color" class="color-picker" onchange="changeTextColor(this.value)"
                                    title="Text Color" value="#000000">
                                <input type="color" class="color-picker" onchange="changeBackgroundColor(this.value)"
                                    title="Background Color" value="#ffff00">
                                <button class="toolbar-btn" onclick="clearFormatting()" title="Clear Formatting">
                                    <i class="bi bi-eraser"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <button class="toolbar-btn" onclick="execCommand('justifyLeft')" title="Align Left">
                                    <i class="bi bi-text-left"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('justifyCenter')" title="Align Center">
                                    <i class="bi bi-text-center"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('justifyRight')" title="Align Right">
                                    <i class="bi bi-text-right"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('justifyFull')" title="Justify">
                                    <i class="bi bi-justify"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Second Row - Lists, Links, Media -->
                        <div class="toolbar-row">
                            <div class="toolbar-group">
                                <select class="form-select form-select-sm" onchange="formatHeading(this.value)"
                                    style="min-width: 120px;">
                                    <option value="">Paragraph</option>
                                    <option value="h1">Heading 1</option>
                                    <option value="h2">Heading 2</option>
                                    <option value="h3">Heading 3</option>
                                    <option value="h4">Heading 4</option>
                                    <option value="h5">Heading 5</option>
                                    <option value="h6">Heading 6</option>
                                </select>
                            </div>

                            <div class="toolbar-group">
                                <button class="toolbar-btn" onclick="insertList('ul')" title="Bulleted List">
                                    <i class="bi bi-list-ul"></i>
                                </button>
                                <button class="toolbar-btn" onclick="insertList('ol')" title="Numbered List">
                                    <i class="bi bi-list-ol"></i>
                                </button>

                                <button class="toolbar-btn" onclick="execCommand('indent')" title="Indent">
                                    <i class="bi bi-text-indent-left"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('outdent')" title="Outdent">
                                    <i class="bi bi-text-indent-right"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <button class="toolbar-btn" onclick="insertLink()" title="Insert Link">
                                    <i class="bi bi-link-45deg"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('unlink')" title="Remove Link">
                                    <i class="bi bi-slash-lg"></i>
                                </button>
                                <button class="toolbar-btn" onclick="insertHorizontalRule()" title="Horizontal Line">
                                    <i class="bi bi-hr"></i>
                                </button>
                            </div>

                            <!-- Insert Content Dropdown -->
                            <div class="insert-content-dropdown">
                                <button class="insert-dropdown-btn" onclick="toggleInsertDropdown()">
                                    <i class="bi bi-plus-circle"></i>
                                    <span>Insert</span>
                                    <i class="bi bi-chevron-down"></i>
                                </button>

                                <div class="insert-dropdown-menu" id="insertDropdown">
                                    <div class="insert-section">
                                        <div class="insert-section-title">Media</div>
                                        <div class="insert-option" onclick="openMediaLibrary(); closeInsertDropdown();">
                                            <div class="insert-option-icon">
                                                <i class="bi bi-image"></i>
                                            </div>
                                            <div class="insert-option-content">
                                                <h6>Image</h6>
                                                <small>Add photos with captions</small>
                                            </div>
                                        </div>
                                        <div class="insert-option" onclick="insertVideoEmbed(); closeInsertDropdown();">
                                            <div class="insert-option-icon">
                                                <i class="bi bi-play-circle"></i>
                                            </div>
                                            <div class="insert-option-content">
                                                <h6>Video</h6>
                                                <small>Embed YouTube, Vimeo videos</small>
                                            </div>
                                        </div>
                                        <div class="insert-option" onclick="insertAudioEmbed(); closeInsertDropdown();">
                                            <div class="insert-option-icon">
                                                <i class="bi bi-music-note"></i>
                                            </div>
                                            <div class="insert-option-content">
                                                <h6>Audio</h6>
                                                <small>Add audio files or podcasts</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="insert-section">
                                        <div class="insert-section-title">Special Content</div>
                                        <div class="insert-option" onclick="insertQuote(); closeInsertDropdown();">
                                            <div class="insert-option-icon">
                                                <i class="bi bi-quote"></i>
                                            </div>
                                            <div class="insert-option-content">
                                                <h6>Quote</h6>
                                                <small>Highlighted quotations</small>
                                            </div>
                                        </div>
                                        <div class="insert-option" onclick="insertInterview(); closeInsertDropdown();">
                                            <div class="insert-option-icon">
                                                <i class="bi bi-chat-left-quote"></i>
                                            </div>
                                            <div class="insert-option-content">
                                                <h6>Interview Q&A</h6>
                                                <small>Question and answer format</small>
                                            </div>
                                        </div>
                                        <div class="insert-option" onclick="insertCallout(); closeInsertDropdown();">
                                            <div class="insert-option-icon">
                                                <i class="bi bi-info-circle"></i>
                                            </div>
                                            <div class="insert-option-content">
                                                <h6>Callout Box</h6>
                                                <small>Important notes and tips</small>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="insert-section">
                                        <div class="insert-section-title">Structure</div>
                                        <div class="insert-option" onclick="insertTable(); closeInsertDropdown();">
                                            <div class="insert-option-icon">
                                                <i class="bi bi-table"></i>
                                            </div>
                                            <div class="insert-option-content">
                                                <h6>Table</h6>
                                                <small>Data tables and comparisons</small>
                                            </div>
                                        </div>
                                        <div class="insert-option" onclick="insertCodeBlock(); closeInsertDropdown();">
                                            <div class="insert-option-icon">
                                                <i class="bi bi-code-square"></i>
                                            </div>
                                            <div class="insert-option-content">
                                                <h6>Code Block</h6>
                                                <small>Formatted code snippets</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Editor Content Area -->
                    <div id="mainEditor" contenteditable="true" class="main-editor"
                        oninput="updateWordCount(); autoSave()" onpaste="handlePaste(event)"
                        onkeydown="handleKeyDown(event)" data-placeholder="Start writing your article content here...">
                        <p>Click here to start writing your article content...</p>
                    </div>

                    <!-- Word Count Info -->
                    <div class="word-count-info">
                        <span id="wordCount">0</span> words, <span id="charCount">0</span> characters
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn btn-outline-secondary" onclick="saveDraft()">
                            <i class="bi bi-save me-1"></i> Save Draft
                        </button>
                        <button class="btn btn-outline-info" onclick="previewArticle()">
                            <i class="bi bi-eye me-1"></i> Preview
                        </button>
                        <button class="btn btn-primary" onclick="publishArticle()">
                            <i class="bi bi-send me-1"></i> Publish Article
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Featured Image -->
                <div class="sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <i class="bi bi-image"></i>
                            Featured Image
                        </div>
                        <div class="sidebar-content">
                            <div class="media-upload-area" onclick="openFeaturedImageLibrary()"
                                id="featuredImageContainer">
                                <i class="bi bi-plus-circle fs-1 text-muted"></i>
                                <p class="text-muted mb-0 mt-2">Click to set featured image</p>
                            </div>
                            <div id="featuredImagePreview" style="display: none;">
                                <img id="featuredImage" class="img-fluid rounded mb-2">
                                <input type="text" id="featuredImageAlt" class="form-control form-control-sm mb-2"
                                    placeholder="Alt text for accessibility">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-secondary btn-sm"
                                        onclick="openFeaturedImageLibrary()">Change Image</button>
                                    <button class="btn btn-outline-danger btn-sm"
                                        onclick="removeFeaturedImage()">Remove</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Article Stats -->
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <i class="bi bi-bar-chart"></i>
                            Article Statistics
                        </div>
                        <div class="sidebar-content">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="fw-bold text-primary" id="sidebarWordCount">0</div>
                                    <small class="text-muted">Words</small>
                                </div>
                                <div class="col-4">
                                    <div class="fw-bold text-success" id="paragraphCount">0</div>
                                    <small class="text-muted">Paragraphs</small>
                                </div>
                                <div class="col-4">
                                    <div class="fw-bold text-info" id="readingTime">0</div>
                                    <small class="text-muted">Min Read</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SEO -->
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <i class="bi bi-search"></i>
                            SEO Settings
                        </div>
                        <div class="sidebar-content">
                            <div class="mb-3">
                                <label class="form-label small">Meta Title</label>
                                <input type="text" id="metaTitle" class="form-control form-control-sm" maxlength="60"
                                    oninput="updateSEOCount()">
                                <small class="text-muted"><span id="metaTitleCount">0</span>/60</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small">Meta Description</label>
                                <textarea id="metaDescription" class="form-control form-control-sm" rows="3"
                                    maxlength="160" oninput="updateSEOCount()"></textarea>
                                <small class="text-muted"><span id="metaDescCount">0</span>/160</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small">Focus Keywords</label>
                                <input type="text" id="focusKeywords" class="form-control form-control-sm"
                                    placeholder="Separate with commas">
                            </div>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <i class="bi bi-tags"></i>
                            Tags
                        </div>
                        <div class="sidebar-content">
                            <div id="tagsList" class="mb-2"></div>
                            <input type="text" id="newTags" class="form-control form-control-sm"
                                placeholder="Add tags, separate with commas"
                                onkeypress="if(event.key==='Enter') addTags()" onblur="addTags()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Library Modal -->
    <div class="modal-overlay" id="mediaModal">
        <div class="modal-content">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-images me-2"></i>Media Library
                </h5>
                <button class="btn-close" onclick="closeModal()"></button>
            </div>

            <!-- Upload Progress Section -->
            <div id="uploadProgressSection" style="display: none;" class="p-3 border-bottom">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="bi bi-cloud-upload-alt me-2"></i>Processing Files
                            <span class="badge bg-primary ms-2" id="uploadCount">0</span>
                        </h6>
                    </div>
                    <div class="card-body" id="uploadProgressContainer">
                        <!-- Progress items will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Upload Controls -->
            <div class="p-3 border-bottom">
                <input type="file" multiple accept="image/*,video/*,.pdf,.doc,.docx,.txt" id="fileInput"
                    class="form-control mb-2" onchange="handleEnhancedFileUpload(event)">
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-primary btn-sm" onclick="document.getElementById('fileInput').click()" id="uploadBtn">
                        <i class="bi bi-upload me-1"></i> Upload Files
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="insertSelectedMedia()" id="insertBtn"
                        style="display: none;">
                        <i class="bi bi-check-circle me-1"></i> Insert Selected
                    </button>
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Images will be automatically optimized for web
                    </small>
                </div>
            </div>

            <!-- Media Grid -->
            <div class="p-3">
                <div class="row" id="mediaGrid">
                    <!-- Media items from Django -->
                    {% for media in recent_media %}
                    <div class="col-md-3 mb-3">
                        <div class="media-item border rounded p-2 cursor-pointer position-relative"
                            onclick="selectMedia(this, '{{ media.cloudinary_url }}', '{{ media.id }}')">
                            {% if media.file_type == 'image' %}
                            <img src="{{ media.cloudinary_url }}" class="img-fluid rounded mb-1" alt="{{ media.title }}"
                                style="aspect-ratio: 1; object-fit: cover;">
                            {% else %}
                            <div class="d-flex align-items-center justify-content-center bg-light rounded mb-1"
                                style="aspect-ratio: 1;">
                                <i class="bi bi-{% if media.file_type == 'video' %}play-circle{% elif media.file_type == 'document' %}file-text{% else %}file{% endif %} fs-1 text-muted"></i>
                            </div>
                            {% endif %}
                            <small class="text-muted d-block text-truncate">{{ media.title }}</small>
                            <small class="text-muted">{{ media.file_size_formatted }}</small>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="bi bi-images fs-1 text-muted mb-3"></i>
                            <h6>No Media Files</h6>
                            <p class="text-muted">Upload your first media file to get started</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Category Creation Modal -->
    <div class="modal-overlay" id="categoryModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Add New Category</h5>
                <button class="btn-close" onclick="closeCategoryModal()"></button>
            </div>
            <div class="p-3">
                <form id="categoryForm">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name *</label>
                        <input type="text" id="categoryName" class="form-control" placeholder="e.g., analysis, campaign, explainer" required>
                        <small class="form-text text-muted">Enter a short identifier (lowercase, no spaces)</small>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDisplayName" class="form-label">Display Name *</label>
                        <input type="text" id="categoryDisplayName" class="form-control" placeholder="e.g., Policy Analysis" required>
                        <small class="form-text text-muted">This is what users will see</small>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Description</label>
                        <textarea id="categoryDescription" class="form-control" rows="3" placeholder="Brief description of this category"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="categoryColor" class="form-label">Color</label>
                        <input type="color" id="categoryColor" class="form-control" value="#dc2626">
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Category</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Author Creation Modal -->
    <div class="modal-overlay" id="authorModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Add New Author</h5>
                <button class="btn-close" onclick="closeAuthorModal()"></button>
            </div>
            <div class="p-3">
                <form id="authorForm">
                    <div class="mb-3">
                        <label for="authorName" class="form-label">Full Name *</label>
                        <input type="text" id="authorName" class="form-control" placeholder="e.g., John Doe" required>
                    </div>
                    <div class="mb-3">
                        <label for="authorTitle" class="form-label">Professional Title</label>
                        <input type="text" id="authorTitle" class="form-control" placeholder="e.g., Senior Policy Analyst">
                    </div>
                    <div class="mb-3">
                        <label for="authorEmail" class="form-label">Email</label>
                        <input type="email" id="authorEmail" class="form-control" placeholder="john.doe@example.com">
                    </div>
                    <div class="mb-3">
                        <label for="authorBio" class="form-label">Biography</label>
                        <textarea id="authorBio" class="form-control" rows="3" placeholder="Brief professional biography"></textarea>
                    </div>
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" onclick="closeAuthorModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Author</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Django data for JavaScript
        const DJANGO_DATA = {
            categories: [
                {% for category in categories %}
                { id: '{{ category.id }}', name: '{{ category.display_name }}', slug: '{{ category.name }}' },
                {% endfor %}
            ],
            authors: [
                {% for author in authors %}
                { id: '{{ author.id }}', name: '{{ author.name }}' },
                {% endfor %}
            ],
            mediaFiles: [
                {% for media in all_media %}
                { id: '{{ media.id }}', title: '{{ media.title }}', url: '{{ media.cloudinary_url }}', type: '{{ media.file_type }}' },
                {% endfor %}
            ],
            csrfToken: document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
            saveUrl: '/dashboard/ajax/save-article/',
            uploadUrl: '/dashboard/ajax/upload-file/',
            previewUrl: '/article/preview/',
            currentUser: {{ request.user.id }}
        };

        let savedRange = null;
        let cursorIndicator = null;

        let selectedMediaUrl = null;
        let selectedMediaId = null;
        let mediaLibraryMode = 'content'; // 'content' or 'featured'
        let articleData = {
            id: null,
            title: '',
            excerpt: '',
            category_id: '',
            author_id: '',
            status: 'draft',
            content: '',
            featured_image_id: null,
            meta_title: '',
            meta_description: '',
            tags: []
        };

        // Auto-save functionality
        let autoSaveTimeout = null;

        function cleanContentForSaving(htmlContent) {
            // Create a temporary div to parse and clean the HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;

            // Remove all image controls
            const imageControls = tempDiv.querySelectorAll('.image-controls');
            imageControls.forEach(control => control.remove());

            // Remove cursor indicators
            const cursorIndicators = tempDiv.querySelectorAll('.cursor-indicator');
            cursorIndicators.forEach(indicator => indicator.remove());

            // Clean up image blocks - keep only essential structure
            const imageBlocks = tempDiv.querySelectorAll('.editor-image-block');
            imageBlocks.forEach(block => {
                const img = block.querySelector('img');
                const caption = block.querySelector('.editor-image-caption');

                if (img) {
                    // Clean up image attributes - remove any editor-specific attributes
                    img.removeAttribute('draggable');
                    img.removeAttribute('ondragstart');
                    img.removeAttribute('ondragend');
                    img.style.cursor = 'auto';
                }

                // Clean up caption
                if (caption) {
                    caption.removeAttribute('contenteditable');
                    caption.removeAttribute('data-placeholder');
                    caption.removeAttribute('onfocus');
                    caption.removeAttribute('onblur');

                    // If caption is empty or just placeholder text, remove it
                    if (!caption.textContent.trim() || caption.textContent.trim() === 'Click to add image caption...') {
                        caption.remove();
                    }
                }
            });

            // Remove any contenteditable attributes from all elements
            const editableElements = tempDiv.querySelectorAll('[contenteditable]');
            editableElements.forEach(el => {
                el.removeAttribute('contenteditable');
                el.removeAttribute('data-placeholder');
            });

            // Remove any onclick handlers and other editor-specific attributes
            const interactiveElements = tempDiv.querySelectorAll('[onclick], [onblur], [onfocus]');
            interactiveElements.forEach(el => {
                el.removeAttribute('onclick');
                el.removeAttribute('onblur');
                el.removeAttribute('onfocus');
                el.removeAttribute('onkeypress');
                el.removeAttribute('oninput');
            });

            return tempDiv.innerHTML;
        }

        function autoSave() {
            // Clear existing timeout
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }

            // Set new timeout for auto-save
            autoSaveTimeout = setTimeout(() => {
                saveArticleData(false); // false = don't show success message
            }, 2000);

            // Update article data
            updateArticleData();
        }

        function updateArticleData() {
            articleData.title = document.getElementById('articleTitle').value;
            articleData.excerpt = document.getElementById('articleExcerpt').value;
            articleData.category_id = document.getElementById('articleCategory').value;
            articleData.author_id = document.getElementById('articleAuthor').value;
            articleData.status = document.getElementById('articleStatus').value;
            articleData.content = cleanContentForSaving(document.getElementById('mainEditor').innerHTML);
            articleData.meta_title = document.getElementById('metaTitle').value;
            articleData.meta_description = document.getElementById('metaDescription').value;
            articleData.publication_date = document.getElementById('publicationDate').value;
        }

        // Font size and line height functions
        function changeFontSize(size) {
            if (size) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0 && !selection.isCollapsed) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.style.fontSize = size;

                    try {
                        range.surroundContents(span);
                    } catch (e) {
                        span.appendChild(range.extractContents());
                        range.insertNode(span);
                    }

                    selection.removeAllRanges();
                    autoSave();
                }
            }
        }

        function changeLineHeight(height) {
            if (height) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    let container = range.commonAncestorContainer;

                    // Find the paragraph or block element
                    while (container && container.nodeType !== 1) {
                        container = container.parentNode;
                    }

                    if (container && (container.tagName === 'P' || container.tagName === 'DIV')) {
                        container.style.lineHeight = height;
                        autoSave();
                    }
                }
            }
        }

        async function saveArticleData(showMessage = true) {
            updateArticleData();

            try {
                const response = await fetch(DJANGO_DATA.saveUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': DJANGO_DATA.csrfToken,
                    },
                    body: JSON.stringify(articleData)
                });

                const result = await response.json();

                if (result.success) {
                    // Update article ID if this was a new article
                    if (result.article_id && !articleData.id) {
                        articleData.id = result.article_id;
                    }
                    
                    if (showMessage) {
                        showNotification(result.message, 'success');
                    }
                    
                    // Update auto-save indicator
                    document.getElementById('autoSaveTime').textContent = 'just now';
                    
                } else {
                    if (showMessage) {
                        showNotification(result.error || 'Failed to save article', 'danger');
                    }
                    console.error('Save error:', result);
                }

                return result.success;
            } catch (error) {
                if (showMessage) {
                    showNotification('Network error while saving', 'danger');
                }
                console.error('Save error:', error);
                return false;
            }
        }

        function showNotification(message, type = 'info') {
            // Create Bootstrap alert
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alert);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Toolbar Functions
        function execCommand(command, value = null) {
            document.execCommand(command, false, value);
            updateWordCount();
            autoSave();
        }

        function formatHeading(tag) {
            if (tag) {
                document.execCommand('formatBlock', false, tag);
            } else {
                document.execCommand('formatBlock', false, 'p');
            }
            updateWordCount();
            autoSave();
        }

        function changeTextColor(color) {
            document.execCommand('foreColor', false, color);
            autoSave();
        }

        function changeBackgroundColor(color) {
            document.execCommand('backColor', false, color);
            autoSave();
        }

        function clearFormatting() {
            document.execCommand('removeFormat', false, null);
            autoSave();
        }

        function insertList(type) {
            const command = type === 'ul' ? 'insertUnorderedList' : 'insertOrderedList';
            document.execCommand(command, false, null);
            updateWordCount();
            autoSave();
        }

        function insertLink() {
            const selection = window.getSelection();

            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                const selectedText = selection.toString();
                const url = prompt('Enter URL:', 'https://');

                if (url && url !== 'https://') {
                    const linkHtml = `<a href="${url}" target="_blank" rel="noopener noreferrer">${selectedText}</a>`;
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(document.createRange().createContextualFragment(linkHtml));
                    selection.removeAllRanges();
                    updateWordCount();
                    autoSave();
                }
            } else {
                const url = prompt('Enter URL:', 'https://');
                if (!url || url === 'https://') return;

                const linkText = prompt('Enter link text:', 'Click here');
                if (!linkText) return;

                const linkHtml = `<a href="${url}" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
                insertContentAtCursorSimple(linkHtml);
            }
        }

        function insertHorizontalRule() {
            const hrHtml = `<hr style="border: none; border-top: 2px solid #e5e7eb; margin: 2rem 0;"><p><br></p>`;
            insertContentAtCursorSimple(hrHtml);
        }

        // Insert Content Functions
        function toggleInsertDropdown() {
            const dropdown = document.getElementById('insertDropdown');
            dropdown.classList.toggle('show');
        }

        function closeInsertDropdown() {
            const dropdown = document.getElementById('insertDropdown');
            dropdown.classList.remove('show');

            setTimeout(() => {
                const editor = document.getElementById('mainEditor');
                editor.focus();
            }, 10);
        }

        function insertQuote() {
            const selection = window.getSelection();

            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString().trim();

                if (selectedText) {
                    const attribution = prompt('Enter attribution (optional):') || '';

                    let quoteHtml = `<div class="quote-block" style="background: #f9fafb; border-left: 4px solid #6b7280; padding: 1.5rem; margin: 1.5rem 0; font-style: italic; font-size: 1.125rem; border-radius: 0 8px 8px 0;">
                        <div contenteditable="true">${selectedText}</div>`;

                    if (attribution) {
                        quoteHtml += `<div style="margin-top: 0.75rem; font-size: 0.9rem; font-style: normal; font-weight: 600; color: #6b7280;" contenteditable="true">— ${attribution}</div>`;
                    }

                    quoteHtml += `</div><p><br></p>`;

                    range.deleteContents();
                    range.insertNode(document.createRange().createContextualFragment(quoteHtml));
                    selection.removeAllRanges();
                    updateWordCount();
                    autoSave();
                    return;
                }
            }

            const quote = prompt('Enter the quote:');
            if (!quote) return;

            const attribution = prompt('Enter attribution (optional):') || '';

            let quoteHtml = `<div class="quote-block" style="background: #f9fafb; border-left: 4px solid #6b7280; padding: 1.5rem; margin: 1.5rem 0; font-style: italic; font-size: 1.125rem; border-radius: 0 8px 8px 0;">
                <div contenteditable="true">${quote}</div>`;

            if (attribution) {
                quoteHtml += `<div style="margin-top: 0.75rem; font-size: 0.9rem; font-style: normal; font-weight: 600; color: #6b7280;" contenteditable="true">— ${attribution}</div>`;
            }

            quoteHtml += `</div><p><br></p>`;

            insertContentAtCursorSimple(quoteHtml);
        }

        function insertInterview() {
            const question = prompt('Enter the question:');
            if (!question) return;

            const answer = prompt('Enter the answer:');
            if (!answer) return;

            const interviewHtml = `<div class="interview-block" style="background: #f0f9ff; border-left: 4px solid #0ea5e9; padding: 1.5rem; margin: 1.5rem 0; border-radius: 0 8px 8px 0;">
                <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;" contenteditable="true"><strong>Q:</strong> ${question}</div>
                <div style="margin-bottom: 1rem;" contenteditable="true"><strong>A:</strong> ${answer}</div>
            </div><p><br></p>`;

            insertContentAtCursorSimple(interviewHtml);
        }

        function insertCallout() {
            const selection = window.getSelection();

            if (selection.rangeCount > 0 && !selection.isCollapsed) {
                const range = selection.getRangeAt(0);
                const selectedText = range.toString().trim();

                if (selectedText) {
                    const title = prompt('Enter callout title (optional):') || '';

                    let calloutHtml = `<div class="callout-block" style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0;">`;

                    if (title) {
                        calloutHtml += `<div style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem;" contenteditable="true">${title}</div>`;
                    }

                    calloutHtml += `<div contenteditable="true">${selectedText}</div></div><p><br></p>`;

                    range.deleteContents();
                    range.insertNode(document.createRange().createContextualFragment(calloutHtml));
                    selection.removeAllRanges();
                    updateWordCount();
                    autoSave();
                    return;
                }
            }

            const content = prompt('Enter callout content:');
            if (!content) return;

            const title = prompt('Enter callout title (optional):') || '';

            let calloutHtml = `<div class="callout-block" style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 8px; padding: 1.5rem; margin: 1.5rem 0;">`;

            if (title) {
                calloutHtml += `<div style="font-weight: 600; color: #92400e; margin-bottom: 0.75rem;" contenteditable="true">${title}</div>`;
            }

            calloutHtml += `<div contenteditable="true">${content}</div></div><p><br></p>`;

            insertContentAtCursorSimple(calloutHtml);
        }

        function insertTable() {
            const rows = parseInt(prompt('Number of rows:', '3'));
            if (!rows || rows < 1) return;

            const cols = parseInt(prompt('Number of columns:', '3'));
            if (!cols || cols < 1) return;

            let tableHtml = `<div style="margin: 1.5rem 0; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <tbody>`;

            for (let i = 0; i < rows; i++) {
                tableHtml += '<tr>';
                for (let j = 0; j < cols; j++) {
                    const isHeader = i === 0;
                    const cellStyle = `padding: 12px; border: 1px solid #e5e7eb; min-width: 100px; background: ${isHeader ? '#f9fafb' : '#fff'}; ${isHeader ? 'font-weight: 600;' : ''}`;
                    const cellContent = isHeader ? `Header ${j + 1}` : `Cell ${i}-${j + 1}`;
                    tableHtml += `<td style="${cellStyle}" contenteditable="true">${cellContent}</td>`;
                }
                tableHtml += '</tr>';
            }

            tableHtml += `</tbody></table></div><p><br></p>`;

            insertContentAtCursorSimple(tableHtml);
        }

        function insertCodeBlock() {
            const code = prompt('Enter code:');
            if (!code) return;

            const language = prompt('Programming language (optional):') || '';

            const codeHtml = `<div style="margin: 1.5rem 0;">
                ${language ? `<div style="background: #374151; color: #f9fafb; padding: 0.5rem 1rem; font-size: 0.75rem; font-weight: 600; border-radius: 8px 8px 0 0;">${language}</div>` : ''}
                <pre style="background: #f1f5f9; border: 1px solid #e5e7eb; padding: 1rem; ${language ? 'border-radius: 0 0 8px 8px;' : 'border-radius: 8px;'} overflow-x: auto; font-family: 'Courier New', monospace; font-size: 0.875rem; margin: 0;" contenteditable="true"><code>${code}</code></pre>
            </div><p><br></p>`;

            insertContentAtCursorSimple(codeHtml);
        }

        function insertVideoEmbed() {
            const url = prompt('Enter video URL (YouTube, Vimeo, etc.):');
            if (!url) return;

            let embedHtml = '';

            if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const videoId = url.includes('youtu.be') ?
                    url.split('/').pop().split('?')[0] :
                    url.split('v=')[1]?.split('&')[0];

                if (videoId) {
                    embedHtml = `<div style="margin: 2rem 0; text-align: center;">
                        <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                            <iframe src="https://www.youtube.com/embed/${videoId}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" allowfullscreen></iframe>
                        </div>
                        <div style="margin-top: 0.75rem; font-size: 0.875rem; color: #6b7280; font-style: italic;" contenteditable="true">Click to add video caption...</div>
                    </div><p><br></p>`;
                }
            } else if (url.includes('vimeo.com')) {
                const videoId = url.split('/').pop().split('?')[0];
                embedHtml = `<div style="margin: 2rem 0; text-align: center;">
                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
                        <iframe src="https://player.vimeo.com/video/${videoId}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" allowfullscreen></iframe>
                    </div>
                    <div style="margin-top: 0.75rem; font-size: 0.875rem; color: #6b7280; font-style: italic;" contenteditable="true">Click to add video caption...</div>
                </div><p><br></p>`;
            } else {
                embedHtml = `<div style="margin: 2rem 0; padding: 2rem; background: #f8fafc; border: 2px dashed #d1d5db; border-radius: 8px; text-align: center;">
                    <i class="bi bi-play-circle" style="font-size: 3rem; color: #6b7280;"></i>
                    <p style="margin: 1rem 0 0.5rem 0; font-weight: 600; color: #374151;">Video Embed</p>
                    <p style="margin: 0; color: #6b7280; word-break: break-all;"><a href="${url}" target="_blank" style="color: #0ea5e9; text-decoration: none;">${url}</a></p>
                    <div style="margin-top: 1rem; font-size: 0.875rem; color: #6b7280;" contenteditable="true">Click to add video description...</div>
                </div><p><br></p>`;
            }

            if (embedHtml) {
                insertContentAtCursorSimple(embedHtml);
            }
        }

        function insertAudioEmbed() {
            const url = prompt('Enter audio URL or embed code:');
            if (!url) return;

            const title = prompt('Audio title (optional):') || 'Audio Content';

            const audioHtml = `<div style="margin: 2rem 0; padding: 2rem; background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 8px; text-align: center;">
                <i class="bi bi-music-note" style="font-size: 3rem; color: #6b7280; margin-bottom: 1rem; display: block;"></i>
                <h4 style="margin: 0 0 1rem 0; font-weight: 600; color: #374151;">${title}</h4>
                <p style="margin: 0 0 1rem 0; color: #6b7280; font-size: 0.875rem; word-break: break-all;">
                    <a href="${url}" target="_blank" style="color: #0ea5e9; text-decoration: none;">${url}</a>
                </p>
                <div style="margin-top: 1rem; font-size: 0.875rem; color: #6b7280;" contenteditable="true">Click to add audio description...</div>
            </div><p><br></p>`;

            insertContentAtCursorSimple(audioHtml);
        }

        // Media Library Functions
        function openMediaLibrary() {
            // Save current cursor position before opening modal
            saveCursorPosition();

            mediaLibraryMode = 'content';
            document.getElementById('mediaModal').classList.add('show');
        }

        function openFeaturedImageLibrary() {
            mediaLibraryMode = 'featured';
            document.getElementById('mediaModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('mediaModal').classList.remove('show');
            document.getElementById('insertBtn').style.display = 'none';
            selectedMediaUrl = null;
            selectedMediaId = null;
        }

        function selectMedia(element, url, mediaId) {
            // Remove previous selections
            document.querySelectorAll('.media-item').forEach(item => {
                item.classList.remove('selected', 'border-primary');
            });

            // Select current item
            element.classList.add('selected', 'border-primary');
            selectedMediaUrl = url;
            selectedMediaId = mediaId;

            // Show insert button
            document.getElementById('insertBtn').style.display = 'block';

            // Add visual feedback
            element.style.transform = 'scale(0.98)';
            setTimeout(() => {
                element.style.transform = 'scale(1)';
            }, 150);
        }

        function insertSelectedMedia() {
            if (!selectedMediaUrl) return;

            if (mediaLibraryMode === 'featured') {
                setFeaturedImage(selectedMediaUrl, selectedMediaId);
            } else {
                insertImageAtCursor(selectedMediaUrl);
            }

            closeModal();
        }

        function insertImageAtCursor(imageUrl) {
            const editor = document.getElementById('mainEditor');

            // Create the image element with proper CSS classes instead of inline styles
            const imageBlock = document.createElement('div');
            imageBlock.className = 'editor-image-block';
            imageBlock.innerHTML = `
                <div class="image-controls">
                    <button class="image-control-btn" onclick="removeImage(this)" title="Remove Image">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button class="image-control-btn" onclick="editImageCaption(this)" title="Edit Caption">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
                <img src="${imageUrl}" alt="Inserted image"
                     draggable="true"
                     ondragstart="handleImageDragStart(event)"
                     ondragend="handleImageDragEnd(event)">
                <div class="editor-image-caption"
                     contenteditable="true"
                     data-placeholder="Click to add image caption..."
                     onblur="autoSave()"
                     onfocus="this.dataset.placeholder && this.textContent === '' && (this.textContent = '')"></div>
            `;

            // Insert at saved cursor position or at a smart location
            if (savedRange) {
                try {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(savedRange);

                    // Handle different insertion scenarios
                    if (savedRange.startContainer.nodeType === Node.TEXT_NODE) {
                        // We're inside a text node - split it
                        const textNode = savedRange.startContainer;
                        const offset = savedRange.startOffset;

                        // Split the text if we're in the middle
                        if (offset > 0 && offset < textNode.textContent.length) {
                            textNode.splitText(offset);
                        }

                        // Find the paragraph or parent element
                        let parentElement = textNode.parentNode;
                        while (parentElement && parentElement !== editor &&
                               !['P', 'DIV', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(parentElement.tagName)) {
                            parentElement = parentElement.parentNode;
                        }

                        if (parentElement && parentElement !== editor) {
                            // Insert after the current paragraph
                            parentElement.parentNode.insertBefore(imageBlock, parentElement.nextSibling);
                        } else {
                            // Fallback: insert after the text node's parent
                            textNode.parentNode.insertBefore(imageBlock, textNode.nextSibling);
                        }
                    } else {
                        // We're at an element level
                        const container = savedRange.startContainer;
                        if (container === editor) {
                            // Insert at the specified child position
                            const children = Array.from(editor.children);
                            const insertIndex = Math.min(savedRange.startOffset, children.length);
                            if (insertIndex < children.length) {
                                editor.insertBefore(imageBlock, children[insertIndex]);
                            } else {
                                editor.appendChild(imageBlock);
                            }
                        } else {
                            // Insert after the container element
                            container.parentNode.insertBefore(imageBlock, container.nextSibling);
                        }
                    }

                    // Add a paragraph after the image for continued editing
                    const nextP = document.createElement('p');
                    nextP.innerHTML = '<br>';
                    imageBlock.parentNode.insertBefore(nextP, imageBlock.nextSibling);

                    // Position cursor after the image
                    const newRange = document.createRange();
                    newRange.setStart(nextP, 0);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                    savedRange = newRange;

                } catch (error) {
                    console.log('Range insertion failed, using fallback:', error);
                    insertImageAtEnd(editor, imageBlock);
                }
            } else {
                // No saved range, insert at current cursor or end
                insertImageAtEnd(editor, imageBlock);
            }

            // Remove cursor indicator
            if (cursorIndicator) {
                cursorIndicator.remove();
                cursorIndicator = null;
            }

            updateWordCount();
            autoSave();
        }

        // Helper function to insert image at the end or smart position
        function insertImageAtEnd(editor, imageBlock) {
            const selection = window.getSelection();

            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const currentNode = range.startContainer;

                // Find the current paragraph or parent element
                let currentElement = currentNode.nodeType === Node.TEXT_NODE ? currentNode.parentNode : currentNode;

                while (currentElement && currentElement !== editor &&
                       !['P', 'DIV', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'].includes(currentElement.tagName)) {
                    currentElement = currentElement.parentNode;
                }

                if (currentElement && currentElement !== editor) {
                    // Insert after current element
                    currentElement.parentNode.insertBefore(imageBlock, currentElement.nextSibling);
                } else {
                    // Insert at the end
                    editor.appendChild(imageBlock);
                }
            } else {
                // No selection, append to end
                editor.appendChild(imageBlock);
            }
        }

        // Image control functions
        function removeImage(button) {
            const imageBlock = button.closest('.editor-image-block');
            if (confirm('Remove this image?')) {
                imageBlock.remove();
                updateWordCount();
                autoSave();
            }
        }

        function editImageCaption(button) {
            const imageBlock = button.closest('.editor-image-block');
            const caption = imageBlock.querySelector('.editor-image-caption');
            caption.focus();

            // Select all text in caption if it has content
            if (caption.textContent.trim()) {
                const range = document.createRange();
                range.selectNodeContents(caption);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        // Enhanced drag and drop functionality
        function handleImageDragStart(event) {
            event.dataTransfer.effectAllowed = 'move';
            const imageBlock = event.target.closest('.editor-image-block');
            event.dataTransfer.setData('text/html', imageBlock.outerHTML);
            imageBlock.classList.add('dragging');
        }

        function handleImageDragEnd(event) {
            const imageBlock = event.target.closest('.editor-image-block');
            imageBlock.classList.remove('dragging');
        }

        function setFeaturedImage(url, mediaId) {
            const container = document.getElementById('featuredImageContainer');
            const preview = document.getElementById('featuredImagePreview');
            const img = document.getElementById('featuredImage');

            container.style.display = 'none';
            preview.style.display = 'block';
            img.src = url;

            // Store the media ID instead of URL
            articleData.featured_image_id = mediaId;
            selectedMediaUrl = url;
            autoSave();
        }

        function removeFeaturedImage() {
            const container = document.getElementById('featuredImageContainer');
            const preview = document.getElementById('featuredImagePreview');

            container.style.display = 'block';
            preview.style.display = 'none';
            articleData.featured_image_id = null;
            selectedMediaUrl = null;
            autoSave();
        }

        // Enhanced file upload with progress tracking and optimization
        async function handleEnhancedFileUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            const uploadSection = document.getElementById('uploadProgressSection');
            const uploadContainer = document.getElementById('uploadProgressContainer');
            const uploadCount = document.getElementById('uploadCount');
            const uploadBtn = document.getElementById('uploadBtn');

            // Show upload section
            uploadSection.style.display = 'block';
            uploadCount.textContent = files.length;
            uploadBtn.disabled = true;

            for (let file of files) {
                await processAndUploadFile(file, uploadContainer);
            }

            // Re-enable upload button
            uploadBtn.disabled = false;

            // Hide upload section after delay
            setTimeout(() => {
                uploadSection.style.display = 'none';
                uploadContainer.innerHTML = '';
            }, 3000);
        }

        async function uploadToServer(file, uploadId) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(DJANGO_DATA.uploadUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': DJANGO_DATA.csrfToken,
                    },
                    body: formData
                });

                const result = await response.json();
                return result;

            } catch (error) {
                console.error('Upload failed:', error);
                return { success: false, error: error.message };
            }
        }

        async function processAndUploadFile(file, container) {
            const uploadId = Date.now() + Math.random();

            // Create progress item
            const progressItem = document.createElement('div');
            progressItem.className = 'upload-progress-item';
            progressItem.id = `upload-${uploadId}`;
            progressItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <span class="fw-medium">${file.name}</span>
                        <small class="text-muted d-block" id="status-${uploadId}">Starting...</small>
                    </div>
                    <span class="badge bg-primary" id="progress-${uploadId}">0%</span>
                </div>
                <div class="progress-bar-custom">
                    <div class="progress-fill" id="fill-${uploadId}" style="width: 0%"></div>
                </div>
            `;
            container.appendChild(progressItem);

            try {
                // Validate file
                validateFile(file);
                updateProgress(uploadId, 10, 'Validating...');

                // Process image if it's an image file
                let processedFile = file;
                if (file.type.startsWith('image/')) {
                    updateProgress(uploadId, 30, 'Optimizing image...');
                    processedFile = await optimizeImage(file);
                    updateProgress(uploadId, 50, 'Optimization complete');
                }

                // Upload file
                updateProgress(uploadId, 60, 'Uploading...');
                const result = await uploadToServer(processedFile, uploadId);

                if (result.success) {
                    updateProgress(uploadId, 100, 'Upload successful!', true);
                    addMediaToGrid(result.media);

                    // Add optimization badge if image was optimized
                    if (file.type.startsWith('image/')) {
                        const statusEl = document.getElementById(`status-${uploadId}`);
                        statusEl.innerHTML += '<span class="optimization-badge">Optimized</span>';
                    }
                } else {
                    throw new Error(result.error || 'Upload failed');
                }

            } catch (error) {
                updateProgress(uploadId, 0, error.message, false, true);
                console.error('Upload error:', error);
            }
        }

        function updateProgress(uploadId, progress, status, success = false, error = false) {
            const progressEl = document.getElementById(`progress-${uploadId}`);
            const statusEl = document.getElementById(`status-${uploadId}`);
            const fillEl = document.getElementById(`fill-${uploadId}`);
            const itemEl = document.getElementById(`upload-${uploadId}`);

            if (progressEl) progressEl.textContent = error ? 'Failed' : `${progress}%`;
            if (statusEl) statusEl.textContent = status;
            if (fillEl) fillEl.style.width = `${progress}%`;

            if (itemEl) {
                if (success) {
                    itemEl.className = 'upload-progress-item success';
                } else if (error) {
                    itemEl.className = 'upload-progress-item error';
                }
            }
        }

        function validateFile(file) {
            const limits = {
                'image/': 10 * 1024 * 1024,  // 10MB for images
                'video/': 100 * 1024 * 1024, // 100MB for videos
                'application/pdf': 25 * 1024 * 1024, // 25MB for PDFs
                'application/': 25 * 1024 * 1024 // 25MB for other documents
            };

            let maxSize = 5 * 1024 * 1024; // Default 5MB
            for (const [type, size] of Object.entries(limits)) {
                if (file.type.startsWith(type)) {
                    maxSize = size;
                    break;
                }
            }

            if (file.size > maxSize) {
                throw new Error(`File size (${formatFileSize(file.size)}) exceeds maximum allowed size (${formatFileSize(maxSize)})`);
            }

            const allowedTypes = [
                'image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif',
                'video/mp4', 'video/webm', 'video/ogg',
                'application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'text/plain'
            ];

            if (!allowedTypes.includes(file.type)) {
                throw new Error(`File type '${file.type}' is not allowed`);
            }
        }

        async function optimizeImage(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = () => {
                    try {
                        // Calculate optimal dimensions
                        const maxWidth = 1920;
                        const maxHeight = 1080;
                        let { width, height } = calculateOptimalDimensions(
                            img.width, img.height, maxWidth, maxHeight
                        );

                        canvas.width = width;
                        canvas.height = height;

                        // Draw optimized image
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, width, height);
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(
                            (blob) => {
                                if (blob) {
                                    const optimizedFile = new File(
                                        [blob],
                                        file.name.replace(/\.[^/.]+$/, '.webp'),
                                        { type: 'image/webp', lastModified: Date.now() }
                                    );
                                    resolve(optimizedFile);
                                } else {
                                    reject(new Error('Failed to optimize image'));
                                }
                            },
                            'image/webp',
                            0.85 // Quality
                        );
                    } catch (error) {
                        reject(new Error(`Image optimization failed: ${error.message}`));
                    }
                };

                img.onerror = () => reject(new Error('Failed to load image for optimization'));
                img.src = URL.createObjectURL(file);
            });
        }

        function calculateOptimalDimensions(originalWidth, originalHeight, maxWidth, maxHeight) {
            let width = originalWidth;
            let height = originalHeight;

            if (width > maxWidth || height > maxHeight) {
                const aspectRatio = width / height;

                if (width > height) {
                    width = maxWidth;
                    height = maxWidth / aspectRatio;
                } else {
                    height = maxHeight;
                    width = maxHeight * aspectRatio;
                }

                if (height > maxHeight) {
                    height = maxHeight;
                    width = maxHeight * aspectRatio;
                }
                if (width > maxWidth) {
                    width = maxWidth;
                    height = maxWidth / aspectRatio;
                }
            }

            return { width: Math.round(width), height: Math.round(height) };
        }

        function addMediaToGrid(media) {
            const mediaGrid = document.getElementById('mediaGrid');

            // Remove empty state if it exists
            const emptyState = mediaGrid.querySelector('.col-12');
            if (emptyState) {
                emptyState.remove();
            }

            const mediaItem = document.createElement('div');
            mediaItem.className = 'col-md-3 mb-3';

            const isImage = media.file_type === 'image';
            const iconClass = media.file_type === 'video' ? 'play-circle' :
                             media.file_type === 'document' ? 'file-text' : 'file';

            mediaItem.innerHTML = `
                <div class="media-item border rounded p-2 cursor-pointer position-relative"
                    onclick="selectMedia(this, '${media.cloudinary_url}', '${media.id}')">
                    ${isImage ?
                        `<img src="${media.cloudinary_url}" class="img-fluid rounded mb-1" alt="${media.title}"
                            style="aspect-ratio: 1; object-fit: cover;">` :
                        `<div class="d-flex align-items-center justify-content-center bg-light rounded mb-1"
                            style="aspect-ratio: 1;">
                            <i class="bi bi-${iconClass} fs-1 text-muted"></i>
                        </div>`
                    }
                    <small class="text-muted d-block text-truncate">${media.title}</small>
                    <small class="text-muted">${media.file_size || 'Unknown size'}</small>
                </div>
            `;

            mediaGrid.prepend(mediaItem);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }


        // Tags Functions
        function addTags() {
            const input = document.getElementById('newTags');
            const tagsList = document.getElementById('tagsList');

            if (input.value.trim()) {
                const newTags = input.value.split(',').map(tag => tag.trim()).filter(tag => tag);

                newTags.forEach(tag => {
                    if (!articleData.tags.includes(tag)) {
                        articleData.tags.push(tag);

                        const tagElement = document.createElement('span');
                        tagElement.className = 'category-badge category-news';
                        tagElement.innerHTML = `${tag} <i class="bi bi-x ms-1" onclick="removeTag('${tag}')" style="cursor: pointer;"></i>`;
                        tagsList.appendChild(tagElement);
                    }
                });

                input.value = '';
                autoSave();
            }
        }

        function removeTag(tag) {
            articleData.tags = articleData.tags.filter(t => t !== tag);
            updateTagsDisplay();
            autoSave();
        }

        function updateTagsDisplay() {
            const tagsList = document.getElementById('tagsList');
            tagsList.innerHTML = '';

            articleData.tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'category-badge category-news';
                tagElement.innerHTML = `${tag} <i class="bi bi-x ms-1" onclick="removeTag('${tag}')" style="cursor: pointer;"></i>`;
                tagsList.appendChild(tagElement);
            });
        }

        // Status and Category Functions
        function updateStatusBadge() {
            const status = document.getElementById('articleStatus').value;
            const badge = document.getElementById('statusBadge');

            badge.className = `status-badge status-${status}`;
            badge.textContent = status.toUpperCase();

            articleData.status = status;
        }

        function updateCategoryBadge() {
            const category = document.getElementById('articleCategory').value;
            articleData.category_id = category;
        }

        // Add drag and drop support to media modal
        function setupMediaModalDragDrop() {
            const modal = document.getElementById('mediaModal');
            const modalContent = modal.querySelector('.modal-content');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                modalContent.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                modalContent.addEventListener(eventName, () => {
                    modalContent.classList.add('dragover');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                modalContent.addEventListener(eventName, () => {
                    modalContent.classList.remove('dragover');
                });
            });

            modalContent.addEventListener('drop', (e) => {
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    document.getElementById('fileInput').files = e.dataTransfer.files;
                    handleEnhancedFileUpload({ target: { files } });
                }
            });
        }

        // Word Count and Statistics
        function updateWordCount() {
            const editor = document.getElementById('mainEditor');
            const title = document.getElementById('articleTitle').value;
            const excerpt = document.getElementById('articleExcerpt').value;

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = editor.innerHTML;
            const content = tempDiv.textContent || tempDiv.innerText || '';

            let totalWords = 0;
            if (title.trim()) totalWords += title.trim().split(/\s+/).length;
            if (excerpt.trim()) totalWords += excerpt.trim().split(/\s+/).length;
            if (content.trim() && content.trim() !== 'Click here to start writing your article content...') {
                totalWords += content.trim().split(/\s+/).length;
            }

            const paragraphs = editor.querySelectorAll('p, div.quote-block, div.interview-block, div.callout-block, h1, h2, h3, h4, h5, h6').length;

            document.getElementById('wordCount').textContent = totalWords;
            document.getElementById('sidebarWordCount').textContent = totalWords;
            document.getElementById('charCount').textContent = content.length;
            document.getElementById('paragraphCount').textContent = paragraphs;
            document.getElementById('readingTime').textContent = Math.ceil(totalWords / 200);
            document.getElementById('excerptCount').textContent = excerpt.length;
        }

        // SEO Functions
        function updateSEOCount() {
            const metaTitle = document.getElementById('metaTitle').value;
            const metaDescription = document.getElementById('metaDescription').value;

            document.getElementById('metaTitleCount').textContent = metaTitle.length;
            document.getElementById('metaDescCount').textContent = metaDescription.length;
        }

        // Event Handlers
        function handlePaste(event) {
            event.preventDefault();

            const clipboardData = event.clipboardData || window.clipboardData;
            const pastedText = clipboardData.getData('text/plain');

            if (pastedText) {
                const lines = pastedText.split(/\r?\n/);
                let htmlContent = '';

                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine) {
                        htmlContent += `<p>${trimmedLine}</p>`;
                    } else {
                        htmlContent += '<p><br></p>';
                    }
                });

                if (document.execCommand('insertHTML', false, htmlContent)) {
                    updateWordCount();
                    autoSave();
                }
            }
        }

        function handleKeyDown(event) {
            if (event.ctrlKey || event.metaKey) {
                // Handle Ctrl+Shift combinations FIRST (these take priority)
                if (event.shiftKey) {
                    switch (event.key.toLowerCase()) {
                        case 'h':
                            event.preventDefault();
                            cycleHeading();
                            break;
                    }
                }
                // Handle regular Ctrl combinations (without Shift) - REMOVE the number keys here
                else {
                    switch (event.key) {
                        case 'b':
                            event.preventDefault();
                            execCommand('bold');
                            break;
                        case 'i':
                            event.preventDefault();
                            execCommand('italic');
                            break;
                        case 'u':
                            event.preventDefault();
                            execCommand('underline');
                            break;
                        case 'q':
                            event.preventDefault();
                            insertQuote();
                            break;
                        case 's':
                            event.preventDefault();
                            saveDraft();
                            break;
                        case 'k':
                            event.preventDefault();
                            insertLink();
                            break;
                        // REMOVED the number keys (1, 2, 3) completely to avoid conflicts
                    }
                }
            }
        }


        // Add this new function to cycle through headings
        function cycleHeading() {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return;

            let currentElement = selection.anchorNode;

            // Find the parent block element
            while (currentElement && currentElement.nodeType !== 1) {
                currentElement = currentElement.parentNode;
            }

            // Determine current heading level
            let currentLevel = 0;
            if (currentElement) {
                const tagName = currentElement.tagName;
                if (tagName && tagName.match(/^H[1-6]$/)) {
                    currentLevel = parseInt(tagName.charAt(1));
                }
            }

            // Cycle to next heading level (1-6, then back to paragraph)
            let nextLevel;
            if (currentLevel === 0 || currentLevel === 6) {
                nextLevel = 1; // Start with H1 or cycle back from H6
            } else {
                nextLevel = currentLevel + 1;
            }

            // Apply the heading
            if (nextLevel <= 6) {
                formatHeading(`h${nextLevel}`);

                // Show a brief notification of the current heading level
                showHeadingNotification(`Heading ${nextLevel}`);
            }
        }

        // Optional: Show a subtle notification of current heading level
        function showHeadingNotification(text) {
            // Remove any existing notification
            const existingNotification = document.getElementById('headingNotification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create new notification
            const notification = document.createElement('div');
            notification.id = 'headingNotification';
            notification.innerHTML = text;
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--wp-admin-theme-color);
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 6px;
                font-size: 0.875rem;
                font-weight: 600;
                z-index: 10000;
                pointer-events: none;
                opacity: 0.9;
            `;

            document.body.appendChild(notification);

            // Remove after 1 second
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 1000);
        }

        function insertContentAtCursorSimple(htmlContent) {
            const editor = document.getElementById('mainEditor');

            if (editor.textContent === 'Click here to start writing your article content...') {
                editor.innerHTML = '<p><br></p>';
                const range = document.createRange();
                const selection = window.getSelection();
                range.setStart(editor.firstChild, 0);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
            }

            ensureEditorFocus();

            try {
                if (document.execCommand('insertHTML', false, htmlContent)) {
                    updateWordCount();
                    autoSave();
                    return;
                }
            } catch (e) {
                console.log('execCommand failed, using fallback method');
            }
        }

        function ensureEditorFocus() {
            const editor = document.getElementById('mainEditor');
            const selection = window.getSelection();

            let isInEditor = false;
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                let node = range.commonAncestorContainer;
                while (node) {
                    if (node === editor) {
                        isInEditor = true;
                        break;
                    }
                    node = node.parentNode;
                }
            }

            if (!isInEditor) {
                editor.focus();
                const range = document.createRange();
                range.selectNodeContents(editor);
                range.collapse(false);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        }

        // Save Functions
        async function saveDraft() {
            const success = await saveArticleData(true);
            if (success) {
                showNotification('Draft saved successfully!', 'success');
            }
        }

        async function publishArticle() {
            updateArticleData();

            if (!articleData.title.trim()) {
                showNotification('Please enter a title for your article.', 'warning');
                document.getElementById('articleTitle').focus();
                return;
            }

            if (!articleData.excerpt.trim()) {
                showNotification('Please add an excerpt for your article.', 'warning');
                document.getElementById('articleExcerpt').focus();
                return;
            }

            if (!articleData.category_id) {
                showNotification('Please select a category for your article.', 'warning');
                document.getElementById('articleCategory').focus();
                return;
            }

            if (!articleData.author_id) {
                showNotification('Please select an author for your article.', 'warning');
                document.getElementById('articleAuthor').focus();
                return;
            }

            const content = document.getElementById('mainEditor').textContent || '';
            if (!content.trim() || content.trim() === 'Click here to start writing your article content...') {
                showNotification('Please add some content to your article.', 'warning');
                document.getElementById('mainEditor').focus();
                return;
            }

            const wordCount = content.trim().split(/\s+/).length;
            if (wordCount < 50) {
                showNotification('Article content seems too short. Please add more content (at least 50 words).', 'warning');
                document.getElementById('mainEditor').focus();
                return;
            }

            document.getElementById('articleStatus').value = 'published';
            updateStatusBadge();

            const success = await saveArticleData(true);
            if (success) {
                showNotification('Article published successfully!', 'success');

                setTimeout(() => {
                    if (confirm('Would you like to preview the published article?')) {
                        previewArticle();
                    }
                }, 1000);
            }
        }

        function previewArticle() {
            updateArticleData();

            const authorName = document.getElementById('articleAuthor').selectedOptions[0]?.text || 'Unknown Author';
            const categoryName = DJANGO_DATA.categories.find(c => c.id === articleData.category_id)?.name || 'news';

            // Get featured image URL - check multiple sources
            let featuredImageUrl = 'https://picsum.photos/800/600?random=5'; // Default fallback

            // First, check if there's a featured image set
            const featuredImageElement = document.getElementById('featuredImage');
            if (featuredImageElement && featuredImageElement.src && !featuredImageElement.src.includes('picsum.photos')) {
                featuredImageUrl = featuredImageElement.src;
            }
            // Otherwise, check if there's a selectedMediaUrl from media selection
            else if (selectedMediaUrl && !selectedMediaUrl.includes('picsum.photos')) {
                featuredImageUrl = selectedMediaUrl;
            }
            // Finally, check if articleData has featured_image_id and we can get URL from media library
            else if (articleData.featured_image_id && DJANGO_DATA.mediaFiles) {
                const mediaItem = DJANGO_DATA.mediaFiles.find(m => m.id === articleData.featured_image_id);
                if (mediaItem) {
                    featuredImageUrl = mediaItem.url;
                }
            }

            const previewData = {
                title: articleData.title || 'Untitled Article',
                excerpt: articleData.excerpt || 'No excerpt provided...',
                category: categoryName,
                author: authorName,
                content: cleanContentForSaving(document.getElementById('mainEditor').innerHTML) || '<p>No content yet...</p>',
                featured_image: featuredImageUrl
            };

            localStorage.setItem('previewArticleData', JSON.stringify(previewData));

            const previewUrl = new URL(DJANGO_DATA.previewUrl, window.location.origin);
<!--            previewUrl.searchParams.append('title', previewData.title);-->
<!--            previewUrl.searchParams.append('excerpt', previewData.excerpt);-->
<!--            previewUrl.searchParams.append('category', previewData.category);-->
<!--            previewUrl.searchParams.append('author', previewData.author);-->

            const previewWindow = window.open(previewUrl.toString(), '_blank');

            if (previewWindow) {
                const sendData = () => {
                    if (previewWindow.document.readyState === 'complete') {
                        previewWindow.postMessage({
                            type: 'articleData',
                            article: previewData
                        }, '*');
                    } else {
                        setTimeout(sendData, 100);
                    }
                };
                setTimeout(sendData, 500);
            }
        }

        // Category Modal Functions
        function openCategoryModal() {
            document.getElementById('categoryModal').classList.add('show');
        }

        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('show');
            document.getElementById('categoryForm').reset();
        }

        function openAuthorModal() {
            document.getElementById('authorModal').classList.add('show');
        }

        function closeAuthorModal() {
            document.getElementById('authorModal').classList.remove('show');
            document.getElementById('authorForm').reset();
        }

        function saveCursorPosition() {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                savedRange = selection.getRangeAt(0).cloneRange();
                updateCursorIndicator();
            }
        }

        function updateCursorIndicator() {
            // Remove existing indicator
            if (cursorIndicator) {
                cursorIndicator.remove();
            }

            if (!savedRange) return;

            // Create new indicator
            cursorIndicator = document.createElement('div');
            cursorIndicator.className = 'cursor-indicator';

            // Position the indicator
            try {
                const rect = savedRange.getBoundingClientRect();
                const editorRect = document.getElementById('mainEditor').getBoundingClientRect();

                cursorIndicator.style.left = (rect.left - editorRect.left) + 'px';
                cursorIndicator.style.top = (rect.top - editorRect.top) + 'px';

                document.getElementById('mainEditor').appendChild(cursorIndicator);

                // Remove indicator after 3 seconds
                setTimeout(() => {
                    if (cursorIndicator) {
                        cursorIndicator.remove();
                        cursorIndicator = null;
                    }
                }, 3000);
            } catch (error) {
                console.log('Could not create cursor indicator:', error);
            }
        }

        // Auto-generate category name from display name
        document.getElementById('categoryDisplayName').addEventListener('input', function() {
            const displayName = this.value;
            const categoryNameInput = document.getElementById('categoryName');

            // Only auto-generate if category name is empty
            if (!categoryNameInput.value) {
                // Convert display name to slug-like format
                const generatedName = displayName
                    .toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '') // Remove special characters
                    .replace(/\s+/g, '_') // Replace spaces with underscores
                    .substring(0, 50); // Limit length

                categoryNameInput.value = generatedName;
            }
        });

        // Allow manual editing but provide validation
        document.getElementById('categoryName').addEventListener('input', function() {
            const value = this.value;
            // Clean the input to ensure it's URL-friendly
            this.value = value
                .toLowerCase()
                .replace(/[^a-z0-9_]/g, ''); // Only allow lowercase letters, numbers, and underscores
        });

        // Handle Category Form Submission
        document.getElementById('categoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                name: document.getElementById('categoryName').value,
                display_name: document.getElementById('categoryDisplayName').value,
                description: document.getElementById('categoryDescription').value,
                color_code: document.getElementById('categoryColor').value
            };

            try {
                const response = await fetch('/dashboard/ajax/create-category/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': DJANGO_DATA.csrfToken,
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    // Add new option to select
                    const categorySelect = document.getElementById('articleCategory');
                    const newOption = document.createElement('option');
                    newOption.value = result.category.id;
                    newOption.textContent = result.category.display_name;
                    newOption.selected = true;
                    categorySelect.appendChild(newOption);

                    // Close modal and update article data
                    closeCategoryModal();
                    showNotification('Category created successfully!', 'success');
                    updateCategoryBadge();
                    autoSave();
                } else {
                    showNotification(result.error || 'Failed to create category', 'danger');
                }
            } catch (error) {
                showNotification('Network error while creating category', 'danger');
                console.error('Error:', error);
            }
        });

        // Handle Author Form Submission
        document.getElementById('authorForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                name: document.getElementById('authorName').value,
                title: document.getElementById('authorTitle').value,
                email: document.getElementById('authorEmail').value,
                bio: document.getElementById('authorBio').value
            };

            try {
                const response = await fetch('/dashboard/ajax/create-author/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': DJANGO_DATA.csrfToken,
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    // Add new option to select
                    const authorSelect = document.getElementById('articleAuthor');
                    const newOption = document.createElement('option');
                    newOption.value = result.author.id;
                    newOption.textContent = result.author.name;
                    newOption.selected = true;
                    authorSelect.appendChild(newOption);

                    // Close modal
                    closeAuthorModal();
                    showNotification('Author created successfully!', 'success');
                    autoSave();
                } else {
                    showNotification(result.error || 'Failed to create author', 'danger');
                }
            } catch (error) {
                showNotification('Network error while creating author', 'danger');
                console.error('Error:', error);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateWordCount();
            setupMediaModalDragDrop();

            const editor = document.getElementById('mainEditor');

            editor.addEventListener('focus', function() {
                if (this.textContent === 'Click here to start writing your article content...') {
                    this.innerHTML = '<p><br></p>';
                    const range = document.createRange();
                    const selection = window.getSelection();
                    range.setStart(this.firstChild, 0);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            });

            editor.addEventListener('input', function(e) {
                setTimeout(() => {
                    updateWordCount();
                    autoSave();
                }, 10);
            });

            // Set default publication date to now
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('publicationDate').value = now.toISOString().slice(0, 16);

            // Handle click outside dropdown
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('insertDropdown');
                const button = event.target.closest('.insert-dropdown-btn');
                if (!button && dropdown && !dropdown.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Set default author to current user if available
            const currentUserAuthor = DJANGO_DATA.authors.find(author => author.id == DJANGO_DATA.currentUser);
            if (currentUserAuthor) {
                document.getElementById('articleAuthor').value = currentUserAuthor.id;
                articleData.author_id = currentUserAuthor.id;
            }

            // Auto-save every 30 seconds
            setInterval(() => {
                updateArticleData();
                if (articleData.title || articleData.excerpt || articleData.content) {
                    saveArticleData(false);
                }
            }, 30000);

            // Enhanced event listeners for cursor tracking
            editor.addEventListener('click', saveCursorPosition);
            editor.addEventListener('keyup', saveCursorPosition);
            editor.addEventListener('mouseup', saveCursorPosition);

            // Handle drag and drop for better image positioning
            editor.addEventListener('dragover', function(event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                editor.classList.add('drag-over');
            });

            editor.addEventListener('dragleave', function(event) {
                if (!editor.contains(event.relatedTarget)) {
                    editor.classList.remove('drag-over');
                }
            });

            editor.addEventListener('drop', function(event) {
                event.preventDefault();
                editor.classList.remove('drag-over');

                const draggedHTML = event.dataTransfer.getData('text/html');
                if (!draggedHTML) return;

                // Remove the original dragged image
                const draggingImage = document.querySelector('.editor-image-block.dragging');
                if (draggingImage) {
                    draggingImage.remove();
                }

                // Create new image element at drop position
                const range = document.caretRangeFromPoint(event.clientX, event.clientY);
                if (range) {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                    savedRange = range;

                    // Insert the dragged image at the new position
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = draggedHTML;
                    const imageBlock = tempDiv.firstElementChild;

                    insertImageAtCursor(imageBlock.querySelector('img').src);
                }

                updateWordCount();
                autoSave();
            });
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>

</html>