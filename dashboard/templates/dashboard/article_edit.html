<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Article - {{ article.title }} - CISD Dashboard</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css"
        rel="stylesheet">

    <!-- CSRF Token -->
    <meta name="csrf-token" content="{{ csrf_token }}">

    <style>
        :root {
            --wp-admin-theme-color: #0EA5E9;
            --wp-admin-theme-color-darker: #0284C7;
            --analysis-color: #dc2626;
            --campaign-color: #059669;
            --explainer-color: #7c3aed;
            --qna-color: #ea580c;
            --news-color: #0284c7;
            --research-color: #7c2d12;
        }

        body {
            background-color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .dashboard-header {
            background: #1e293b;
            color: #fff;
            padding: 1rem 0;
        }

        .editor-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .editor-main {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .editor-header {
            background: linear-gradient(135deg, #0EA5E9 0%, #0284C7 100%);
            color: white;
            padding: 1.5rem 2rem;
        }

        .article-title-input {
            border: none;
            outline: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.8rem;
            font-weight: 600;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 1rem;
        }

        .article-title-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .article-title-input:focus {
            background: rgba(255, 255, 255, 0.2);
        }

        .article-meta-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-draft {
            background: #fef3c7;
            color: #92400e;
        }

        .status-review {
            background: #ddd6fe;
            color: #5b21b6;
        }

        .status-published {
            background: #d1fae5;
            color: #065f46;
        }

        .status-scheduled {
            background: #bfdbfe;
            color: #1e40af;
        }

        /* Enhanced Toolbar */
        .enhanced-toolbar {
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .toolbar-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .toolbar-row:last-child {
            margin-bottom: 0;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding-right: 0.75rem;
            border-right: 1px solid #d1d5db;
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .toolbar-btn {
            background: none;
            border: 1px solid transparent;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            color: #374151;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            position: relative;
        }

        .toolbar-btn:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }

        .toolbar-btn.active {
            background: var(--wp-admin-theme-color);
            color: white;
            border-color: var(--wp-admin-theme-color);
        }

        /* Tooltip for keyboard shortcuts */
        .toolbar-btn[data-shortcut]:hover::after {
            content: attr(data-shortcut);
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            z-index: 1000;
        }

        .color-picker {
            width: 32px;
            height: 32px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            padding: 0;
        }

        /* Font size and line spacing dropdowns */
        .font-size-select, .line-spacing-select {
            min-width: 80px;
            font-size: 0.875rem;
        }

        /* Main Editor */
        .main-editor {
            min-height: 600px;
            padding: 2rem;
            font-size: 1rem;
            line-height: 1.7;
            outline: none;
            border: none;
            background: white;
            color: #374151;
        }

        .main-editor:focus {
            outline: none;
        }

        .main-editor p {
            margin-bottom: 1.2rem;
        }

        .main-editor h1,
        .main-editor h2,
        .main-editor h3,
        .main-editor h4,
        .main-editor h5,
        .main-editor h6 {
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-weight: 600;
            color: #1f2937;
        }

        .main-editor h1 {
            font-size: 2rem;
        }

        .main-editor h2 {
            font-size: 1.75rem;
        }

        .main-editor h3 {
            font-size: 1.5rem;
        }

        .main-editor h4 {
            font-size: 1.25rem;
        }

        /* Image blocks - centered and properly styled */
        .image-block {
            margin: 2rem 0;
            text-align: center;
            clear: both;
            display: block;
            width: 100%;
        }

        .image-block img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: block;
            margin: 0 auto;
        }

        .image-caption {
            font-size: 0.875rem;
            color: #6b7280;
            font-style: italic;
            margin-top: 0.75rem;
            text-align: center;
        }

        /* Quote blocks - RED sidebar */
        .quote-block {
            background: #f9fafb;
            border-left: 4px solid #dc2626; /* RED color */
            padding: 1.5rem;
            margin: 1.5rem 0;
            font-style: italic;
            font-size: 1.125rem;
            border-radius: 0 8px 8px 0;
            clear: both;
        }

        .interview-block {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 8px 8px 0;
        }

        .interview-q {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .interview-a {
            margin-bottom: 1rem;
        }

        .callout-block {
            background: #fffbeb;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .callout-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.75rem;
        }

        /* Publication Date Field */
        .publication-date-field {
            margin-bottom: 1rem;
        }

        .publication-date-field label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .publication-date-field input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem;
            border-radius: 6px;
            width: 100%;
        }

        .publication-date-field input:focus {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            outline: none;
        }

        /* Excerpt Area */
        .excerpt-area {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            background: #fafbfc;
        }

        .excerpt-input {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.875rem;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
        }

        .excerpt-input:focus {
            outline: none;
            border-color: var(--wp-admin-theme-color);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            height: fit-content;
        }

        .sidebar-section {
            border-bottom: 1px solid #e5e7eb;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-header {
            background: #f8fafc;
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-content {
            padding: 1.5rem;
        }

        .media-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .media-upload-area:hover {
            border-color: var(--wp-admin-theme-color);
            background: #f0f9ff;
        }

        /* Action Buttons */
        .action-buttons {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 1rem 2rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .btn-primary {
            background: var(--wp-admin-theme-color);
            border-color: var(--wp-admin-theme-color);
        }

        .btn-primary:hover {
            background: var(--wp-admin-theme-color-darker);
            border-color: var(--wp-admin-theme-color-darker);
        }

        /* Word count info */
        .word-count-info {
            position: absolute;
            bottom: 1rem;
            right: 2rem;
            font-size: 0.875rem;
            color: #6b7280;
            background: rgba(248, 250, 252, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }

        /* Edit mode indicator */
        .edit-mode-indicator {
            background: #f59e0b;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: 1rem;
        }

        @media (max-width: 1024px) {
            .article-meta-row {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .toolbar-row {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-group {
                border-right: none;
                border-bottom: 1px solid #d1d5db;
                padding-bottom: 0.5rem;
                margin-bottom: 0.5rem;
            }
        }

        @media (max-width: 768px) {
            .editor-container {
                padding: 1rem;
            }

            .main-editor {
                padding: 1rem;
            }
        }
    </style>
</head>

<body>
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <a href="/dashboard/" style="color: white; text-decoration: none;">
                        <i class="bi bi-arrow-left me-2"></i>
                        Edit Article
                    </a>
                    <span class="edit-mode-indicator">EDITING</span>
                </h4>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-light">Auto-saved <span id="autoSaveTime">just now</span></span>
                    <button class="btn btn-outline-light btn-sm" onclick="previewArticle()">
                        <i class="bi bi-eye me-1"></i> Preview Changes
                    </button>
                    <a href="{% url 'article_detail' article.slug %}" class="btn btn-outline-light btn-sm" target="_blank">
                        <i class="bi bi-external-link me-1"></i> View Live
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid editor-container">
        <div class="row">
            <!-- Main Editor Column -->
            <div class="col-lg-8">
                <div class="editor-main">
                    <!-- Article Header -->
                    <div class="editor-header">
                        <input type="text" id="articleTitle" class="article-title-input"
                            placeholder="Enter your article title here..." 
                            value="{{ article.title }}"
                            oninput="updateWordCount(); autoSave()">

                        <!-- Publication Date Field -->
                        <div class="publication-date-field">
                            <label for="publicationDate">Publication Date</label>
                            <input type="datetime-local" id="publicationDate" 
                                value="{% if article.published_date %}{{ article.published_date|date:'Y-m-d\TH:i' }}{% endif %}"
                                onchange="autoSave()">
                        </div>

                        <div class="article-meta-row">
                            <select id="articleCategory" class="form-select"
                                onchange="updateCategoryBadge(); autoSave()">
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}" {% if category.id == article.category.id %}selected{% endif %}>{{ category.display_name }}</option>
                                {% endfor %}
                            </select>

                            <select id="articleAuthor" class="form-select" onchange="autoSave()">
                                <option value="">Select Author</option>
                                {% for author in authors %}
                                <option value="{{ author.id }}" {% if author.id == article.author.id %}selected{% endif %}>{{ author.name }}</option>
                                {% endfor %}
                            </select>

                            <select id="articleStatus" class="form-select" onchange="updateStatusBadge(); autoSave()">
                                <option value="draft" {% if article.status == 'draft' %}selected{% endif %}>Draft</option>
                                <option value="review" {% if article.status == 'review' %}selected{% endif %}>Under Review</option>
                                <option value="scheduled" {% if article.status == 'scheduled' %}selected{% endif %}>Scheduled</option>
                                <option value="published" {% if article.status == 'published' %}selected{% endif %}>Published</option>
                            </select>

                            <span class="status-badge status-{{ article.status }}" id="statusBadge">{{ article.status|upper }}</span>
                        </div>
                    </div>

                    <!-- Article Excerpt -->
                    <div class="excerpt-area">
                        <label class="form-label fw-semibold text-muted">Article Excerpt</label>
                        <textarea id="articleExcerpt" class="excerpt-input" rows="3" maxlength="500"
                            placeholder="Write a compelling excerpt that summarizes your article..."
                            oninput="updateWordCount(); autoSave()">{{ article.excerpt }}</textarea>
                        <small class="text-muted">
                            <span id="excerptCount">{{ article.excerpt|length }}</span>/500 characters
                        </small>
                    </div>

                    <!-- Enhanced Toolbar (same as create template) -->
                    <div class="enhanced-toolbar">
                        <!-- First Row - Text Formatting -->
                        <div class="toolbar-row">
                            <div class="toolbar-group">
                                <button class="toolbar-btn" onclick="execCommand('undo')" title="Undo" data-shortcut="Ctrl+Z">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('redo')" title="Redo" data-shortcut="Ctrl+Y">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <button class="toolbar-btn" onclick="execCommand('bold')" title="Bold" data-shortcut="Ctrl+B">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('italic')" title="Italic" data-shortcut="Ctrl+I">
                                    <i class="bi bi-type-italic"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('underline')" title="Underline" data-shortcut="Ctrl+U">
                                    <i class="bi bi-type-underline"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('strikethrough')" title="Strikethrough">
                                    <i class="bi bi-type-strikethrough"></i>
                                </button>
                                <button class="toolbar-btn" onclick="insertQuote()" title="Quote" data-shortcut="Ctrl+Q">
                                    <i class="bi bi-quote"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <!-- Font Size -->
                                <select class="form-select form-select-sm font-size-select" onchange="changeFontSize(this.value)" title="Font Size">
                                    <option value="">Size</option>
                                    <option value="10px">10px</option>
                                    <option value="12px">12px</option>
                                    <option value="14px">14px</option>
                                    <option value="16px">16px</option>
                                    <option value="18px">18px</option>
                                    <option value="20px">20px</option>
                                    <option value="24px">24px</option>
                                    <option value="28px">28px</option>
                                    <option value="32px">32px</option>
                                </select>

                                <!-- Line Spacing -->
                                <select class="form-select form-select-sm line-spacing-select" onchange="changeLineHeight(this.value)" title="Line Spacing">
                                    <option value="">Spacing</option>
                                    <option value="1">1.0</option>
                                    <option value="1.15">1.15</option>
                                    <option value="1.5">1.5</option>
                                    <option value="2">2.0</option>
                                    <option value="2.5">2.5</option>
                                    <option value="3">3.0</option>
                                </select>
                            </div>

                            <div class="toolbar-group">
                                <input type="color" class="color-picker" onchange="changeTextColor(this.value)"
                                    title="Text Color" value="#000000">
                                <input type="color" class="color-picker" onchange="changeBackgroundColor(this.value)"
                                    title="Background Color" value="#ffff00">
                                <button class="toolbar-btn" onclick="clearFormatting()" title="Clear Formatting" data-shortcut="Ctrl+Space">
                                    <i class="bi bi-eraser"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <button class="toolbar-btn" onclick="alignText('left')" title="Align Left" data-shortcut="Ctrl+Shift+L">
                                    <i class="bi bi-text-left"></i>
                                </button>
                                <button class="toolbar-btn" onclick="alignText('center')" title="Align Center" data-shortcut="Ctrl+Shift+E">
                                    <i class="bi bi-text-center"></i>
                                </button>
                                <button class="toolbar-btn" onclick="alignText('right')" title="Align Right" data-shortcut="Ctrl+Shift+R">
                                    <i class="bi bi-text-right"></i>
                                </button>
                                <button class="toolbar-btn" onclick="alignText('justify')" title="Justify" data-shortcut="Ctrl+Shift+J">
                                    <i class="bi bi-justify"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Second Row - Lists, Links, Media -->
                        <div class="toolbar-row">
                            <div class="toolbar-group">
                                <select class="form-select form-select-sm" onchange="formatHeading(this.value)"
                                    style="min-width: 120px;">
                                    <option value="">Paragraph</option>
                                    <option value="h1">Heading 1</option>
                                    <option value="h2">Heading 2</option>
                                    <option value="h3">Heading 3</option>
                                    <option value="h4">Heading 4</option>
                                    <option value="h5">Heading 5</option>
                                    <option value="h6">Heading 6</option>
                                </select>
                            </div>

                            <div class="toolbar-group">
                                <button class="toolbar-btn" onclick="insertList('ul')" title="Bulleted List">
                                    <i class="bi bi-list-ul"></i>
                                </button>
                                <button class="toolbar-btn" onclick="insertList('ol')" title="Numbered List">
                                    <i class="bi bi-list-ol"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('indent')" title="Indent">
                                    <i class="bi bi-indent-left"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('outdent')" title="Outdent">
                                    <i class="bi bi-indent-right"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <button class="toolbar-btn" onclick="insertLink()" title="Insert Link" data-shortcut="Ctrl+K">
                                    <i class="bi bi-link-45deg"></i>
                                </button>
                                <button class="toolbar-btn" onclick="execCommand('unlink')" title="Remove Link">
                                    <i class="bi bi-link-broken"></i>
                                </button>
                                <button class="toolbar-btn" onclick="insertHorizontalRule()" title="Horizontal Line">
                                    <i class="bi bi-hr"></i>
                                </button>
                            </div>

                            <div class="toolbar-group">
                                <button class="toolbar-btn" onclick="openMediaLibrary()" title="Insert Image">
                                    <i class="bi bi-image"></i>
                                    <span>Image</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Main Editor Content Area -->
                    <div id="mainEditor" contenteditable="true" class="main-editor"
                        oninput="updateWordCount(); autoSave()" onpaste="handlePaste(event)"
                        onkeydown="handleKeyDown(event)" data-placeholder="Start writing your article content here...">
                        {% if article.content_sections.first.content %}
                            {{ article.content_sections.first.content|safe }}
                        {% else %}
                            <p>Click here to start editing your article content...</p>
                        {% endif %}
                    </div>

                    <!-- Word Count Info -->
                    <div class="word-count-info">
                        <span id="wordCount">0</span> words, <span id="charCount">0</span> characters
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn btn-outline-secondary" onclick="saveDraft()">
                            <i class="bi bi-save me-1"></i> Save Changes
                        </button>
                        <button class="btn btn-outline-info" onclick="previewArticle()">
                            <i class="bi bi-eye me-1"></i> Preview
                        </button>
                        {% if article.status != 'published' %}
                        <button class="btn btn-success" onclick="publishArticle()">
                            <i class="bi bi-send me-1"></i> Publish Article
                        </button>
                        {% else %}
                        <button class="btn btn-primary" onclick="updateArticle()">
                            <i class="bi bi-save me-1"></i> Update Article
                        </button>
                        {% endif %}
                        <a href="{% url 'article_detail' article.slug %}" class="btn btn-outline-secondary" target="_blank">
                            <i class="bi bi-external-link me-1"></i> View Live
                        </a>
                    </div>
                </div>
            </div>

            <!-- Sidebar (same as create template but with populated data) -->
            <div class="col-lg-4">
                <!-- Featured Image -->
                <div class="sidebar">
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <i class="bi bi-image"></i>
                            Featured Image
                        </div>
                        <div class="sidebar-content">
                            {% if article.featured_image %}
                            <div id="featuredImagePreview">
                                <img id="featuredImage" src="{{ article.featured_image.cloudinary_url }}" class="img-fluid rounded mb-2">
                                <input type="text" id="featuredImageAlt" class="form-control form-control-sm mb-2"
                                    placeholder="Alt text for accessibility" value="{{ article.featured_image.alt_text }}">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-secondary btn-sm"
                                        onclick="openFeaturedImageLibrary()">Change Image</button>
                                    <button class="btn btn-outline-danger btn-sm"
                                        onclick="removeFeaturedImage()">Remove</button>
                                </div>
                            </div>
                            {% else %}
                            <div class="media-upload-area" onclick="openFeaturedImageLibrary()"
                                id="featuredImageContainer">
                                <i class="bi bi-plus-circle fs-1 text-muted"></i>
                                <p class="text-muted mb-0 mt-2">Click to set featured image</p>
                            </div>
                            <div id="featuredImagePreview" style="display: none;">
                                <img id="featuredImage" class="img-fluid rounded mb-2">
                                <input type="text" id="featuredImageAlt" class="form-control form-control-sm mb-2"
                                    placeholder="Alt text for accessibility">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-secondary btn-sm"
                                        onclick="openFeaturedImageLibrary()">Change Image</button>
                                    <button class="btn btn-outline-danger btn-sm"
                                        onclick="removeFeaturedImage()">Remove</button>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Article Stats -->
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <i class="bi bi-bar-chart"></i>
                            Article Statistics
                        </div>
                        <div class="sidebar-content">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="fw-bold text-primary" id="sidebarWordCount">0</div>
                                    <small class="text-muted">Words</small>
                                </div>
                                <div class="col-4">
                                    <div class="fw-bold text-success" id="paragraphCount">0</div>
                                    <small class="text-muted">Paragraphs</small>
                                </div>
                                <div class="col-4">
                                    <div class="fw-bold text-info" id="readingTime">0</div>
                                    <small class="text-muted">Min Read</small>
                                </div>
                            </div>
                            <hr>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="fw-bold text-warning">{{ article.view_count }}</div>
                                    <small class="text-muted">Views</small>
                                </div>
                                <div class="col-6">
                                    <div class="fw-bold text-info">{{ article.updated_at|timesince }}</div>
                                    <small class="text-muted">Last Edit</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SEO -->
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <i class="bi bi-search"></i>
                            SEO Settings
                        </div>
                        <div class="sidebar-content">
                            <div class="mb-3">
                                <label class="form-label small">Meta Title</label>
                                <input type="text" id="metaTitle" class="form-control form-control-sm" maxlength="60"
                                    value="{{ article.meta_title }}" oninput="updateSEOCount()">
                                <small class="text-muted"><span id="metaTitleCount">{{ article.meta_title|length }}</span>/60</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small">Meta Description</label>
                                <textarea id="metaDescription" class="form-control form-control-sm" rows="3"
                                    maxlength="160" oninput="updateSEOCount()">{{ article.meta_description }}</textarea>
                                <small class="text-muted"><span id="metaDescCount">{{ article.meta_description|length }}</span>/160</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small">Focus Keywords</label>
                                <input type="text" id="focusKeywords" class="form-control form-control-sm"
                                    value="{{ article.meta_keywords }}" placeholder="Separate with commas">
                            </div>
                        </div>
                    </div>

                    <!-- Tags -->
                    <div class="sidebar-section">
                        <div class="sidebar-header">
                            <i class="bi bi-tags"></i>
                            Tags
                        </div>
                        <div class="sidebar-content">
                            <div id="tagsList" class="mb-2">
                                {% for tag in article.tags.all %}
                                <span class="badge bg-primary me-1 mb-1">
                                    {{ tag.name }} 
                                    <i class="bi bi-x ms-1" onclick="removeTag('{{ tag.name }}')" style="cursor: pointer;"></i>
                                </span>
                                {% endfor %}
                            </div>
                            <input type="text" id="newTags" class="form-control form-control-sm"
                                placeholder="Add tags, separate with commas"
                                onkeypress="if(event.key==='Enter') addTags()" onblur="addTags()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables with article data pre-loaded
        let selectedMediaUrl = {% if article.featured_image %}'{{ article.featured_image.cloudinary_url }}'{% else %}null{% endif %};
        let selectedMediaId = {% if article.featured_image %}'{{ article.featured_image.id }}'{% else %}null{% endif %};
        let mediaLibraryMode = 'content';
        let articleData = {
            id: '{{ article.id }}',
            title: '{{ article.title|escapejs }}',
            excerpt: '{{ article.excerpt|escapejs }}',
            category_id: '{{ article.category.id }}',
            author_id: '{{ article.author.id }}',
            status: '{{ article.status }}',
            content: document.getElementById('mainEditor').innerHTML,
            featured_image_id: {% if article.featured_image %}'{{ article.featured_image.id }}'{% else %}null{% endif %},
            meta_title: '{{ article.meta_title|escapejs }}',
            meta_description: '{{ article.meta_description|escapejs }}',
            tags: [{% for tag in article.tags.all %}'{{ tag.name|escapejs }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            publication_date: '{% if article.published_date %}{{ article.published_date|date:"Y-m-d\TH:i" }}{% endif %}'
        };

        // Include all the same JavaScript functions as the create template
        // (autoSave, updateArticleData, toolbar functions, etc.)
        // The key difference is that the article ID is already set for updates

        let autoSaveTimeout = null;

        function autoSave() {
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }

            autoSaveTimeout = setTimeout(() => {
                saveArticleData(false);
            }, 2000);

            updateArticleData();
        }

        function updateArticleData() {
            articleData.title = document.getElementById('articleTitle').value;
            articleData.excerpt = document.getElementById('articleExcerpt').value;
            articleData.category_id = document.getElementById('articleCategory').value;
            articleData.author_id = document.getElementById('articleAuthor').value;
            articleData.status = document.getElementById('articleStatus').value;
            articleData.content = document.getElementById('mainEditor').innerHTML;
            articleData.meta_title = document.getElementById('metaTitle').value;
            articleData.meta_description = document.getElementById('metaDescription').value;
            articleData.publication_date = document.getElementById('publicationDate').value;
        }

        // All the same functions from the create template...
        // (I'll include the key ones here but they're the same as in the create template)

        async function saveArticleData(showMessage = true) {
            updateArticleData();

            try {
                const response = await fetch('/dashboard/ajax/save-article/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                    },
                    body: JSON.stringify(articleData)
                });

                const result = await response.json();

                if (result.success) {
                    if (showMessage) {
                        showNotification('Article updated successfully!', 'success');
                    }
                    
                    document.getElementById('autoSaveTime').textContent = 'just now';
                } else {
                    if (showMessage) {
                        showNotification(result.error || 'Failed to update article', 'danger');
                    }
                    console.error('Save error:', result);
                }

                return result.success;
            } catch (error) {
                if (showMessage) {
                    showNotification('Network error while saving', 'danger');
                }
                console.error('Save error:', error);
                return false;
            }
        }

        function showNotification(message, type = 'info') {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(alert);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        // Include all the toolbar functions from the create template
        // (execCommand, alignText, changeFontSize, etc.)

        function alignText(alignment) {
            const commands = {
                'left': 'justifyLeft',
                'center': 'justifyCenter', 
                'right': 'justifyRight',
                'justify': 'justifyFull'
            };
            
            document.execCommand(commands[alignment], false, null);
            updateWordCount();
            autoSave();
        }

        function changeFontSize(size) {
            if (size) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0 && !selection.isCollapsed) {
                    const range = selection.getRangeAt(0);
                    const span = document.createElement('span');
                    span.style.fontSize = size;
                    
                    try {
                        range.surroundContents(span);
                    } catch (e) {
                        span.appendChild(range.extractContents());
                        range.insertNode(span);
                    }
                    
                    selection.removeAllRanges();
                    autoSave();
                }
            }
        }

        function changeLineHeight(height) {
            if (height) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    let container = range.commonAncestorContainer;
                    
                    while (container && container.nodeType !== 1) {
                        container = container.parentNode;
                    }
                    
                    if (container && (container.tagName === 'P' || container.tagName === 'DIV')) {
                        container.style.lineHeight = height;
                        autoSave();
                    }
                }
            }
        }

        function execCommand(command, value = null) {
            document.execCommand(command, false, value);
            updateWordCount();
            autoSave();
        }

        function updateWordCount() {
            const editor = document.getElementById('mainEditor');
            const title = document.getElementById('articleTitle').value;
            const excerpt = document.getElementById('articleExcerpt').value;

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = editor.innerHTML;
            const content = tempDiv.textContent || tempDiv.innerText || '';

            let totalWords = 0;
            if (title.trim()) totalWords += title.trim().split(/\s+/).length;
            if (excerpt.trim()) totalWords += excerpt.trim().split(/\s+/).length;
            if (content.trim() && content.trim() !== 'Click here to start editing your article content...') {
                totalWords += content.trim().split(/\s+/).length;
            }

            const paragraphs = editor.querySelectorAll('p, div.quote-block, div.interview-block, div.callout-block, h1, h2, h3, h4, h5, h6').length;

            document.getElementById('wordCount').textContent = totalWords;
            document.getElementById('sidebarWordCount').textContent = totalWords;
            document.getElementById('charCount').textContent = content.length;
            document.getElementById('paragraphCount').textContent = paragraphs;
            document.getElementById('readingTime').textContent = Math.ceil(totalWords / 200);
            document.getElementById('excerptCount').textContent = excerpt.length;
        }

        function updateStatusBadge() {
            const status = document.getElementById('articleStatus').value;
            const badge = document.getElementById('statusBadge');

            badge.className = `status-badge status-${status}`;
            badge.textContent = status.toUpperCase();

            articleData.status = status;
        }

        // Add the tags functions
        function addTags() {
            const input = document.getElementById('newTags');
            const tagsList = document.getElementById('tagsList');

            if (input.value.trim()) {
                const newTags = input.value.split(',').map(tag => tag.trim()).filter(tag => tag);

                newTags.forEach(tag => {
                    if (!articleData.tags.includes(tag)) {
                        articleData.tags.push(tag);

                        const tagElement = document.createElement('span');
                        tagElement.className = 'badge bg-primary me-1 mb-1';
                        tagElement.innerHTML = `${tag} <i class="bi bi-x ms-1" onclick="removeTag('${tag}')" style="cursor: pointer;"></i>`;
                        tagsList.appendChild(tagElement);
                    }
                });

                input.value = '';
                autoSave();
            }
        }

        function removeTag(tag) {
            articleData.tags = articleData.tags.filter(t => t !== tag);
            updateTagsDisplay();
            autoSave();
        }

        function updateTagsDisplay() {
            const tagsList = document.getElementById('tagsList');
            tagsList.innerHTML = '';

            articleData.tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'badge bg-primary me-1 mb-1';
                tagElement.innerHTML = `${tag} <i class="bi bi-x ms-1" onclick="removeTag('${tag}')" style="cursor: pointer;"></i>`;
                tagsList.appendChild(tagElement);
            });
        }

        async function updateArticle() {
            const success = await saveArticleData(true);
            if (success) {
                showNotification('Article updated successfully!', 'success');
            }
        }

        function previewArticle() {
            updateArticleData();

            const authorName = document.getElementById('articleAuthor').selectedOptions[0]?.text || 'Unknown Author';
            const categoryName = document.getElementById('articleCategory').selectedOptions[0]?.text || 'news';

            const previewData = {
                title: articleData.title || 'Untitled Article',
                excerpt: articleData.excerpt || 'No excerpt provided...',
                category: categoryName,
                author: authorName,
                content: articleData.content || '<p>No content yet...</p>',
                featured_image: selectedMediaUrl || 'https://picsum.photos/800/600?random=5'
            };

            localStorage.setItem('previewArticleData', JSON.stringify(previewData));

            const previewUrl = new URL('/article/preview/', window.location.origin);
            const previewWindow = window.open(previewUrl.toString(), '_blank');

            if (previewWindow) {
                const sendData = () => {
                    if (previewWindow.document.readyState === 'complete') {
                        previewWindow.postMessage({
                            type: 'articleData',
                            article: previewData
                        }, '*');
                    } else {
                        setTimeout(sendData, 100);
                    }
                };
                setTimeout(sendData, 500);
            }
        }

        // Initialize with existing data
        document.addEventListener('DOMContentLoaded', function() {
            updateWordCount();
            
            // Show featured image if exists
            {% if article.featured_image %}
            document.getElementById('featuredImageContainer').style.display = 'none';
            document.getElementById('featuredImagePreview').style.display = 'block';
            {% endif %}

            // Auto-save every 30 seconds
            setInterval(() => {
                updateArticleData();
                if (articleData.title || articleData.excerpt || articleData.content) {
                    saveArticleData(false);
                }
            }, 30000);
        });
    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>

</html>